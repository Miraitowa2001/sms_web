# 飞书机器人按钮控制配置指南

为了实现飞书卡片按钮控制设备（如重启、查看状态），需要进行以下配置：

## 1. 飞书开发者后台配置

1.  登录 [飞书开发者后台](https://open.feishu.cn/app)。
2.  创建一个企业自建应用。
3.  **添加机器人能力**：在"添加应用能力"中启用"机器人"。
4.  **权限管理**：
    *   `im:message:send_as_bot` (以应用身份发送消息)
    *   `im:message` (获取用户发给机器人的单聊消息) - 如果需要文本指令
5.  **事件订阅**：
    *   配置 **请求网址 URL**：`https://你的域名/webhook/feishu`
    *   添加事件：
        *   `im.message.receive_v1` (接收消息)
        *   **卡片回传交互** (`card.action.trigger`) - **必须配置**，用于处理按钮点击。
        *   `application.bot.menu_v6` (机器人菜单) - **可选**，如果配置了机器人菜单。

## 2. 服务器配置 (.env)

在 `.env` 文件中添加以下配置：

```env
# 飞书机器人配置
FEISHU_BOT_ENABLED=true
FEISHU_APP_ID=cli_xxxxxxxx  # 你的 App ID
FEISHU_APP_SECRET=xxxxxxxx  # 你的 App Secret
FEISHU_VERIFICATION_TOKEN=xxxxxxxx # 事件订阅的 Verification Token
FEISHU_ENCRYPT_KEY=         # (可选) 如果开启了加密，填写 Encrypt Key
```

## 3. 功能说明

### 3.1 唤起控制面板

有两种方式可以唤起设备控制面板：

1.  **发送指令**：直接给机器人发送 `菜单`、`控制`、`menu` 或 `list`。
2.  **机器人菜单**（推荐）：
    *   在飞书开发者后台 -> 应用功能 -> 机器人 -> 菜单配置。
    *   添加一个菜单项，类型选择 **事件**。
    *   事件 Key 填写：`menu_control` 或 `control`。
    *   发布版本后，用户点击该菜单即可弹出控制面板。

### 3.2 控制面板功能

控制面板会列出所有 **在线** 设备，并提供以下操作：

*   **[查看状态]**：点击后获取设备最新状态并发送新卡片。
*   **[重启]**：点击后弹出确认框，确认后发送重启指令。
*   **[刷新列表]**：刷新当前在线设备列表。

### 3.3 消息通知卡片

当系统推送以下事件时，飞书卡片也将包含操作按钮：

*   **设备状态更新** (`device_status`)
*   **收到短信** (`sms`)
*   **收到来电** (`call`)

## 4. 注意事项

*   确保服务器可以通过公网访问，否则飞书无法回调 Webhook。
*   如果使用了内网穿透，请确保 URL 稳定。
*   按钮点击后，机器人会发送一条新消息反馈操作结果。
