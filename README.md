# ç®¡ç†æœåŠ¡

åŸºäºAPIæ–‡æ¡£å¼€å‘çš„è®¾å¤‡ç®¡ç†æœåŠ¡ï¼Œç”¨äºæ¥æ”¶å¼€å‘æ¿æ¨é€çš„æ¶ˆæ¯å¹¶æä¾›ç®¡ç†åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… æ¥æ”¶å¼€å‘æ¿æ¨é€çš„å„ç±»æ¶ˆæ¯ï¼ˆè”ç½‘ã€çŸ­ä¿¡ã€é€šè¯ç­‰ï¼‰
- âœ… è®¾å¤‡ç®¡ç†ï¼ˆè‡ªåŠ¨æ³¨å†Œã€çŠ¶æ€è·Ÿè¸ªã€ç¦»çº¿æ£€æµ‹ï¼‰
- âœ… SIMå¡ä¿¡æ¯ç®¡ç†
- âœ… çŸ­ä¿¡è®°å½•å­˜å‚¨å’ŒæŸ¥è¯¢
- âœ… é€šè¯è®°å½•å­˜å‚¨å’ŒæŸ¥è¯¢
- âœ… æ¶ˆæ¯æ—¥å¿—è®°å½•
- âœ… Webç®¡ç†ç•Œé¢
- âœ… RESTful API

## æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç±»å‹ | è¯´æ˜ |
|-----|------|-----|------|
| 100 | WIFIå·²è”ç½‘ | 501 | æ–°çŸ­ä¿¡ |
| 101 | å¡æ§½1å·²è”ç½‘ | 502 | çŸ­ä¿¡å¤–å‘æˆåŠŸ |
| 102 | å¡æ§½2å·²è”ç½‘ | 601 | æ¥ç”µæŒ¯é“ƒ |
| 202 | SIMå¡æ³¨å†Œä¸­ | 602 | æ¥ç”µæ¥é€š |
| 203 | SIMå¡IDè·å– | 603 | å¯¹æ–¹æŒ‚æ–­ |
| 204 | SIMå¡å°±ç»ª | 620-623 | å»ç”µç›¸å…³ |
| 205 | SIMå¡å¼¹å‡º | 998 | PINGå¿ƒè·³ |
| 209 | SIMå¡å¼‚å¸¸ | ... | ... |

## ğŸš€ å¿«é€Ÿéƒ¨ç½² (æ¨è)

æœ¬é¡¹ç›®æ”¯æŒ Docker ä¸€é”®éƒ¨ç½²ï¼Œæ— éœ€å®‰è£… Node.js ç¯å¢ƒã€‚

### Windows ç”¨æˆ·
åŒå‡»è¿è¡Œé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `start.bat` è„šæœ¬å³å¯ã€‚

### Linux / macOS ç”¨æˆ·
åœ¨ç»ˆç«¯è¿è¡Œï¼š
```bash
chmod +x start.sh
./start.sh
```

æœåŠ¡å¯åŠ¨åï¼Œè®¿é—®ç®¡ç†ç•Œé¢ï¼š
- åœ°å€: `http://localhost:36001`
- é»˜è®¤è´¦å·: `admin`
- é»˜è®¤å¯†ç : è¯·æŸ¥çœ‹ `.env` æ–‡ä»¶ (é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ç”Ÿæˆ)

> æ›´å¤š Docker é…ç½®è¯¦æƒ…ï¼ˆå¦‚æ•°æ®æŒä¹…åŒ–ã€æ•…éšœæ’æŸ¥ï¼‰ï¼Œè¯·å‚é˜… [Docker éƒ¨ç½²æŒ‡å—](DOCKER_DEPLOY.md)ã€‚

---

## ğŸ› ï¸ æ‰‹åŠ¨éƒ¨ç½² (å¼€å‘ç¯å¢ƒ)

å¦‚æœæ‚¨éœ€è¦ä¿®æ”¹ä»£ç æˆ–è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œå¯ä»¥ä½¿ç”¨ Node.js ç›´æ¥è¿è¡Œã€‚

### 1. å®‰è£…ä¾èµ–

```bash
cd sms_web
npm install
```

### 2. å¯åŠ¨æœåŠ¡

```bash
npm start
```

æˆ–å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰ï¼š
```bash
npm run dev
```

### 3. é…ç½®å¼€å‘æ¿

åœ¨å¼€å‘æ¿åå°ç®¡ç†é¡µé¢ä¸­ï¼Œé…ç½®æ¥å£ä¿¡æ¯ï¼š

- **æ¥å£åœ°å€**: 
  - Dockeréƒ¨ç½²: `http://ä½ çš„æœåŠ¡å™¨IP:36001/push`
  - æ‰‹åŠ¨éƒ¨ç½²: `http://ä½ çš„æœåŠ¡å™¨IP:3000/push`
- **HTTPè¯·æ±‚æ–¹å¼**: `POST`
- **Content-Type**: `application/json`ï¼ˆæ¨èï¼‰

å¦‚æœä½¿ç”¨ Form æ ¼å¼ï¼š
- **æ¥å£åœ°å€**: `.../push-form`
- **Content-Type**: `application/x-www-form-urlencoded`

### 4. è®¿é—®ç®¡ç†ç•Œé¢

- Dockeréƒ¨ç½²: `http://localhost:36001`
- æ‰‹åŠ¨éƒ¨ç½²: `http://localhost:3000`

## ğŸ“š API æ¥å£æ–‡æ¡£

æœ¬æœåŠ¡æä¾›äº†ä¸€å¥—å®Œæ•´çš„ RESTful APIï¼Œç”¨äºè®¾å¤‡ç®¡ç†ã€æ•°æ®æŸ¥è¯¢åŠè¿œç¨‹æ§åˆ¶ã€‚

### 1. é‰´æƒè¯´æ˜

æ‰€æœ‰ç®¡ç†ç±» APIï¼ˆ`/api/*`ï¼‰å‡éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚

- **è®¤è¯æ–¹å¼**: HTTP Basic Auth
- **é»˜è®¤è´¦å·**: `admin`
- **é»˜è®¤å¯†ç **: `admin123` (å¯åœ¨ `.env` æˆ– `src/config.js` ä¸­ä¿®æ”¹)

åœ¨è¯·æ±‚ Header ä¸­æ·»åŠ ï¼š
```http
Authorization: Basic YWRtaW46YWRtaW4xMjM=
```
*(å…¶ä¸­ `YWRtaW46YWRtaW4xMjM=` æ˜¯ `admin:admin123` çš„ Base64 ç¼–ç )*

### 2. è¿œç¨‹æ§åˆ¶ API (æ ¸å¿ƒ)

ç”¨äºå‘è®¾å¤‡å‘é€æŒ‡ä»¤ã€‚**ç‰¹åˆ«è¯´æ˜ï¼š`deviceIp` å‚æ•°æ”¯æŒç›´æ¥å¡«å†™ `è®¾å¤‡ID`ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŸ¥æ‰¾è¯¥è®¾å¤‡æœ€åä¸€æ¬¡ä¸ŠæŠ¥çš„ IP åœ°å€ï¼Œè§£å†³å…¬ç½‘éƒ¨ç½²æ—¶æ— æ³•å›ºå®šå±€åŸŸç½‘ IP çš„é—®é¢˜ã€‚**

#### 2.1 è·å–æ§åˆ¶ Token
æ§åˆ¶æŒ‡ä»¤éœ€è¦ Token è¿›è¡Œå®‰å…¨æ ¡éªŒã€‚

- **æ¥å£**: `GET /api/control/token`
- **å‚æ•°**:
  - `devId`: è®¾å¤‡ID
  - `username`: ç®¡ç†å‘˜ç”¨æˆ·å (é»˜è®¤ admin)
  - `password`: ç®¡ç†å‘˜å¯†ç  (é»˜è®¤ admin)
- **è¿”å›**: `{ "success": true, "data": { "token": "..." } }`

#### 2.2 é€šç”¨æ§åˆ¶æ¥å£
å‘é€ä»»æ„æŒ‡ä»¤åˆ°è®¾å¤‡ã€‚

- **æ¥å£**: `POST /api/control/send`
- **Content-Type**: `application/json`
- **Body**:
```json
{
  "deviceIp": "dev001",      // æ”¯æŒå¡«å†™ è®¾å¤‡ID (æ¨è) æˆ– è®¾å¤‡å±€åŸŸç½‘IP
  "token": "YOUR_TOKEN",     // é€šè¿‡ 2.1 è·å–
  "cmd": "sendsms",          // æŒ‡ä»¤åç§°
  "params": {                // æŒ‡ä»¤å‚æ•°
    "p1": "1",
    "p2": "10086",
    "p3": "cxll"
  }
}
```

#### 2.3 å¸¸ç”¨å¿«æ·æŒ‡ä»¤
ä»¥ä¸‹æ¥å£å‡ä¸º `POST` è¯·æ±‚ï¼ŒBody ä¸­å¿…é¡»åŒ…å« `deviceIp` å’Œ `token`ã€‚

| åŠŸèƒ½ | æ¥å£è·¯å¾„ | é¢å¤– Body å‚æ•° | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **é‡å¯è®¾å¤‡** | `/api/control/restart` | æ—  | ç«‹å³é‡å¯è®¾å¤‡ |
| **å‘é€çŸ­ä¿¡** | `/api/control/sendsms` | `slot` (1/2), `phone`, `content`, `tid` | `tid` ä¸ºäº‹åŠ¡IDï¼Œç”¨äºè¿½è¸ªç»“æœ |
| **æ‹¨æ‰“ç”µè¯** | `/api/control/teldial` | `slot`, `phone`, `duration` (ç§’), `tts` (å†…å®¹) | æ‹¨é€šåå¯æ’­æ”¾ TTS è¯­éŸ³ |
| **æŒ‚æ–­ç”µè¯** | `/api/control/telhangup` | `slot` | æŒ‚æ–­å½“å‰é€šè¯ |
| **å¡æ§½å…³æœº** | `/api/control/slotoff` | `slot` | å…³é—­æŒ‡å®šå¡æ§½çš„æ¨¡ç»„ç”µæº |
| **WiFiæ§åˆ¶** | `/api/control/wf` | `action` ("on"/"off") | å¼€å…³ WiFi |
| **æ¯æ—¥é‡å¯** | `/api/control/dailyrst` | `hour` (0-23) | è®¾ç½®æ¯æ—¥è‡ªåŠ¨é‡å¯æ—¶é—´ |

### 3. æ•°æ®æŸ¥è¯¢ API

ç”¨äºè·å–ç³»ç»Ÿå­˜å‚¨çš„å†å²æ•°æ®ã€‚

| åŠŸèƒ½ | æ¥å£è·¯å¾„ | æ–¹æ³• | å‚æ•° (Query) |
| :--- | :--- | :--- | :--- |
| **è®¾å¤‡åˆ—è¡¨** | `/api/devices` | GET | æ—  |
| **çŸ­ä¿¡è®°å½•** | `/api/sms` | GET | `page`, `limit`, `devId`, `keyword` |
| **é€šè¯è®°å½•** | `/api/calls` | GET | `page`, `limit`, `type` (incoming/outgoing) |
| **ç³»ç»Ÿæ—¥å¿—** | `/api/messages` | GET | `page`, `limit` |

### 4. å¼€å‘æ¿æ¨é€æ¥å£ (Webhook)

ç”¨äºæ¥æ”¶å¼€å‘æ¿ä¸ŠæŠ¥çš„æ•°æ®ï¼Œéœ€åœ¨å¼€å‘æ¿åå°é…ç½®ã€‚

- **æ¥å£åœ°å€**: `http://YOUR_IP:3000/push`
- **æ–¹æ³•**: `POST`
- **é‰´æƒ**: Header `X-API-Key` æˆ– Query `apiKey` (åœ¨ `.env` ä¸­é…ç½® `API_KEY`)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| POST | `/push` | æ¥æ”¶JSONæ ¼å¼æ¨é€ |
| POST | `/push-form` | æ¥æ”¶Formæ ¼å¼æ¨é€ |
| GET | `/push` | æ¥æ”¶GETæ–¹å¼æ¨é€ |

### ç®¡ç†æ¥å£

#### è®¾å¤‡ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| GET | `/api/devices` | è·å–è®¾å¤‡åˆ—è¡¨ |
| GET | `/api/devices/:devId` | è·å–è®¾å¤‡è¯¦æƒ… |
| PUT | `/api/devices/:devId` | æ›´æ–°è®¾å¤‡ä¿¡æ¯ |
| DELETE | `/api/devices/:devId` | åˆ é™¤è®¾å¤‡ |

#### çŸ­ä¿¡è®°å½•

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| GET | `/api/sms` | è·å–çŸ­ä¿¡åˆ—è¡¨ |
| GET | `/api/sms/:devId` | è·å–è®¾å¤‡çŸ­ä¿¡ |

æŸ¥è¯¢å‚æ•°ï¼š
- `devId` - è®¾å¤‡ID
- `phoneNum` - å·ç ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
- `direction` - æ–¹å‘ (in/out)
- `page` - é¡µç 
- `limit` - æ¯é¡µæ•°é‡

#### é€šè¯è®°å½•

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| GET | `/api/calls` | è·å–é€šè¯åˆ—è¡¨ |

æŸ¥è¯¢å‚æ•°ï¼š
- `devId` - è®¾å¤‡ID
- `phoneNum` - å·ç ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
- `callType` - ç±»å‹ (incoming/outgoing/missed)
- `page` - é¡µç 
- `limit` - æ¯é¡µæ•°é‡

#### æ¶ˆæ¯æ—¥å¿—

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| GET | `/api/messages` | è·å–æ¶ˆæ¯æ—¥å¿— |

#### ç»Ÿè®¡ä¿¡æ¯

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| GET | `/api/stats` | è·å–ç»Ÿè®¡æ•°æ® |
| GET | `/api/message-types` | è·å–æ¶ˆæ¯ç±»å‹å®šä¹‰ |

## ç›®å½•ç»“æ„

```
lvyou-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.js           # ä¸»åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ database.js      # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ constants.js     # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ messageHandler.js # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â””â”€â”€ routes.js        # ç®¡ç†APIè·¯ç”±
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html       # Webç®¡ç†ç•Œé¢
â”œâ”€â”€ data/
â”‚   â””â”€â”€ lvyou.db         # SQLiteæ•°æ®åº“ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## æ•°æ®å­˜å‚¨

ä½¿ç”¨ SQLite æ•°æ®åº“ï¼Œæ•°æ®æ–‡ä»¶è‡ªåŠ¨åˆ›å»ºåœ¨ `data/lvyou.db`ã€‚

æ•°æ®è¡¨ï¼š
- `devices` - è®¾å¤‡ä¿¡æ¯
- `sim_cards` - SIMå¡ä¿¡æ¯
- `messages` - æ¶ˆæ¯æ—¥å¿—
- `sms_records` - çŸ­ä¿¡è®°å½•
- `call_records` - é€šè¯è®°å½•

## ç¯å¢ƒå˜é‡

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|-------|------|
| PORT | 3000 | æœåŠ¡ç«¯å£ |

## éƒ¨ç½²å»ºè®®

### ä½¿ç”¨ PM2 éƒ¨ç½²

```bash
npm install -g pm2
pm2 start src/app.js --name lvyou-server
pm2 save
pm2 startup
```

### ä½¿ç”¨ Docker éƒ¨ç½²

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["node", "src/app.js"]
```

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿æœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤3000ï¼‰å¯¹å¼€å‘æ¿å¯è®¿é—®
2. å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨åå‘ä»£ç†ï¼ˆå¦‚ Nginxï¼‰
3. å®šæœŸå¤‡ä»½ `data/lvyou.db` æ•°æ®åº“æ–‡ä»¶
4. è®¾å¤‡ç¦»çº¿æ£€æµ‹é»˜è®¤ä¸º5åˆ†é’Ÿæ— æ´»åŠ¨

## License

ISC
