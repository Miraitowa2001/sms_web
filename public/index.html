<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¨</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <title>IoTè®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ Lucide å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ==================== 1. CSS å˜é‡ä¸é‡ç½® ==================== */
        :root {
            /* å“ç‰Œè‰² */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --secondary: #64748b;
            
            /* çŠ¶æ€è‰² */
            --success: #10b981;
            --success-bg: #d1fae5;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --danger: #ef4444;
            --danger-bg: #fee2e2;
            --info: #3b82f6;
            --info-bg: #dbeafe;

            /* èƒŒæ™¯ä¸æ–‡å­— */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --border-color: #e2e8f0;

            /* ç•Œé¢å‚æ•° */
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --header-height: 64px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            font-size: 14px;
            padding-bottom: 40px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ==================== 2. é€šç”¨ç»„ä»¶ç±» (Modular UI) ==================== */
        
        /* æŒ‰é’® */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 14px;
            white-space: nowrap;
        }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: white; border-color: var(--border-color); color: var(--text-main); }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 4px 10px; font-size: 12px; height: 28px; }
        .btn-icon { padding: 6px; border-radius: 6px; }

        /* å¡ç‰‡ */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248, 250, 252, 0.5);
        }
        .card-header h2 { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }

        /* çŠ¶æ€å¾½ç«  (Modular State Classes) */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            line-height: 1.4;
        }
        .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0.6; }
        .badge-success { background: var(--success-bg); color: #065f46; }
        .badge-success::before { background: var(--success); }
        .badge-warning { background: var(--warning-bg); color: #92400e; }
        .badge-warning::before { background: var(--warning); }
        .badge-danger { background: var(--danger-bg); color: #991b1b; }
        .badge-danger::before { background: var(--danger); }
        .badge-info { background: var(--info-bg); color: #1e40af; }
        .badge-info::before { background: var(--info); }
        .badge-neutral { background: #f1f5f9; color: #475569; }
        .badge-neutral::before { background: #94a3b8; }

        /* è¡¨å•å…ƒç´  */
        .form-control {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: #fff;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .search-box { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }

        /* ==================== 3. å¸ƒå±€ä¸ç»“æ„ ==================== */
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .app-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 0 20px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-md);
        }
        .app-logo { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 600; }
        .user-menu { display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .user-avatar { 
            width: 32px; height: 32px; background: rgba(255,255,255,0.2); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }

        .container { max-width: 1280px; margin: 20px auto; padding: 0 20px; }

        /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .stat-card-icon {
            position: absolute;
            right: 15px;
            top: 15px;
            color: var(--primary-light);
            opacity: 0.5;
            width: 48px; height: 48px;
        }
        .stat-label { color: var(--text-secondary); font-size: 13px; margin-bottom: 4px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
        .stat-detail { font-size: 12px; display: flex; gap: 8px; }
        
        /* å¯¼èˆªæ ‡ç­¾ */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .nav-item {
            padding: 10px 18px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .nav-item:hover { background: #f8fafc; color: var(--primary); }
        .nav-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        /* é¡µé¢åˆ‡æ¢é€»è¾‘ */
        .page-panel { display: none; animation: fadeIn 0.3s ease; }
        .page-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container { width: 100%; overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; table-layout: auto; }
        th { 
            background: #f8fafc; color: var(--text-secondary); 
            font-weight: 600; text-align: left; padding: 12px 16px; 
            font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        /* ç™»å½•é®ç½© */
        .login-overlay {
            position: fixed; inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .login-overlay.active { opacity: 1; pointer-events: auto; }
        .login-card {
            background: white;
            width: 100%; max-width: 380px;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
        }
        .login-icon-wrap {
            width: 64px; height: 64px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 16px;
        }
        .login-card h2 { margin-bottom: 8px; font-size: 20px; }
        .login-card p { color: var(--text-secondary); margin-bottom: 24px; font-size: 14px; }

        /* Toast æç¤º */
        .toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 10px;
            animation: slideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; min-width: 300px;
        }
        .toast-icon { flex-shrink: 0; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.success .toast-icon { color: var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.error .toast-icon { color: var(--danger); }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ==================== 4. ç§»åŠ¨ç«¯é€‚é… (Mobile Optimization) ==================== */
        @media (max-width: 768px) {
            .app-header { padding: 0 16px; height: 56px; }
            .header-title-text { display: none; } /* ä»…æ˜¾ç¤º Logo å›¾æ ‡ */
            .container { margin: 16px auto; padding: 0 16px; }
            
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .stat-card:first-child { grid-column: 1 / -1; } /* ç¬¬ä¸€ä¸ªå¡ç‰‡å æ»¡ä¸€è¡Œ */
            .stat-value { font-size: 24px; }
            
            .card-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .card-header > div { width: 100%; display: flex; gap: 8px; }
            .card-header .btn { flex: 1; }
            
            .search-box { flex-direction: column; }
            .search-box > * { width: 100% !important; }

            /* ç§»åŠ¨ç«¯è¡¨æ ¼å¡ç‰‡åŒ– */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { 
                background: white; 
                border: 1px solid var(--border-color); 
                border-radius: 12px; 
                margin-bottom: 16px; 
                box-shadow: var(--shadow-sm); 
                padding: 12px;
            }
            td { 
                border: none; position: relative; padding: 8px 0 8px 40%; 
                text-align: right; min-height: 36px; display: flex; align-items: center; justify-content: flex-end;
            }
            td::before { 
                position: absolute; left: 0; top: 50%; transform: translateY(-50%);
                width: 35%; white-space: nowrap; font-weight: 600; color: var(--text-secondary); text-align: left;
                content: attr(data-label); 
            }
            /* ç‰¹æ®Šå¤„ç†å¤é€‰æ¡†åˆ— */
            td:has(input[type="checkbox"]) { padding-left: 0; justify-content: flex-start; padding-bottom: 12px; border-bottom: 1px solid #f1f5f9; margin-bottom: 8px; }
            td:has(input[type="checkbox"])::before { content: none; }
            
            /* å†…å®¹æº¢å‡ºå¤„ç† */
            .device-id { word-break: break-all; font-family: monospace; }
            
            /* çŸ­ä¿¡å†…å®¹ç‰¹æ®Šå¤„ç† */
            .sms-content {
                white-space: normal;
                max-width: 100%;
                text-align: left;
            }
            td:has(.sms-content) {
                display: block;
                padding-left: 0;
                text-align: left;
            }
            td:has(.sms-content)::before {
                position: static;
                display: block;
                margin-bottom: 4px;
                transform: none;
            }
        }
        
        /* PCç«¯çŸ­ä¿¡å†…å®¹ä¼˜åŒ– */
        @media (min-width: 769px) {
            .sms-content {
                max-width: 400px;
                white-space: normal;
                word-break: break-all;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="app-header">
        <div class="app-logo">
            <i data-lucide="cpu"></i>
            <span class="header-title-text">IoT ç®¡ç†æ§åˆ¶å°</span>
        </div>
        <div class="user-menu" id="user-menu" style="display: none;">
            <div class="user-avatar"><i data-lucide="user" size="16"></i></div>
            <span id="current-username">ç®¡ç†å‘˜</span>
            <button class="btn btn-sm btn-icon" onclick="App.Auth.logout()" title="é€€å‡ºç™»å½•" style="background: rgba(255,255,255,0.2); border: none; color: white;">
                <i data-lucide="log-out" size="16"></i>
            </button>
        </div>
    </header>

    <div class="container">
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-grid">
            <div class="stat-card">
                <i data-lucide="server" class="stat-card-icon"></i>
                <div class="stat-label">è®¾å¤‡æ€»æ•°</div>
                <div class="stat-value" id="stat-devices">-</div>
                <div class="stat-detail">
                    <span class="badge badge-success" id="stat-online-badge">0 åœ¨çº¿</span>
                    <span class="badge badge-danger" id="stat-offline-badge">0 ç¦»çº¿</span>
                </div>
            </div>
            <div class="stat-card">
                <i data-lucide="message-square" class="stat-card-icon"></i>
                <div class="stat-label">ä»Šæ—¥çŸ­ä¿¡</div>
                <div class="stat-value" id="stat-sms-today">-</div>
                <div class="stat-detail" style="color: var(--text-secondary);">æ€»è®¡: <span id="stat-sms-total">0</span></div>
            </div>
            <div class="stat-card">
                <i data-lucide="phone-call" class="stat-card-icon"></i>
                <div class="stat-label">ä»Šæ—¥é€šè¯</div>
                <div class="stat-value" id="stat-calls-today">-</div>
                <div class="stat-detail" style="color: var(--text-secondary);">æ€»è®¡: <span id="stat-calls-total">0</span></div>
            </div>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <div class="nav-item active" onclick="App.UI.switchTab('devices', this)">
                <i data-lucide="list"></i> è®¾å¤‡åˆ—è¡¨
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('sms', this)">
                <i data-lucide="message-square"></i> çŸ­ä¿¡è®°å½•
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('calls', this)">
                <i data-lucide="phone"></i> é€šè¯è®°å½•
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('logs', this)">
                <i data-lucide="file-text"></i> æ¶ˆæ¯æ—¥å¿—
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('control', this)">
                <i data-lucide="gamepad-2"></i> è¿œç¨‹æ§åˆ¶
            </div>
        </div>

        <!-- é¡µé¢ 1: è®¾å¤‡åˆ—è¡¨ -->
        <div id="panel-devices" class="page-panel active">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="list" size="20"></i> è®¾å¤‡ç®¡ç†</h2>
                    <div>
                        <button class="btn btn-primary" onclick="App.UI.showModal('modal-add-device')">
                            <i data-lucide="plus" size="16"></i> æ·»åŠ è®¾å¤‡
                        </button>
                        <button class="btn btn-secondary" onclick="App.Modules.Devices.refresh()">
                            <i data-lucide="refresh-cw" size="16"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="table-devices">
                            <thead>
                                <tr>
                                    <th>è®¾å¤‡ID</th>
                                    <th>åç§°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>ç½‘ç»œä¿¡æ¯</th>
                                    <th>SIMå¡æ§½</th>
                                    <th>æœ€ååœ¨çº¿</th>
                                </tr>
                            </thead>
                            <tbody><!-- JS å¡«å…… --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢ 2: çŸ­ä¿¡è®°å½• -->
        <div id="panel-sms" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="message-square" size="20"></i> çŸ­ä¿¡è®°å½•</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-danger" onclick="App.Modules.SMS.deleteBatch()">
                            <i data-lucide="trash-2" size="16"></i> åˆ é™¤
                        </button>
                        <button class="btn btn-success" onclick="App.Modules.SMS.export()">
                            <i data-lucide="download" size="16"></i> å¯¼å‡º
                        </button>
                        <button class="btn btn-secondary" onclick="App.Modules.SMS.load()">
                            <i data-lucide="refresh-cw" size="16"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <input type="text" class="form-control" id="sms-search" placeholder="æœç´¢å·ç ..." style="flex:1;">
                        <select class="form-control" id="sms-slot" style="width: 100px;" onchange="App.Modules.SMS.load()">
                            <option value="">å…¨éƒ¨å¡æ§½</option>
                            <option value="1">å¡æ§½1</option>
                            <option value="2">å¡æ§½2</option>
                        </select>
                        <select class="form-control" id="sms-direction" style="width: 120px;" onchange="App.Modules.SMS.load()">
                            <option value="">å…¨éƒ¨æ–¹å‘</option>
                            <option value="in">æ¥æ”¶</option>
                            <option value="out">å‘é€</option>
                        </select>
                        <input type="date" class="form-control" id="sms-date-start" style="width: 140px;" onchange="App.Modules.SMS.load()">
                        <input type="date" class="form-control" id="sms-date-end" style="width: 140px;" onchange="App.Modules.SMS.load()">
                        <button class="btn btn-primary" onclick="App.Modules.SMS.load()">æœç´¢</button>
                    </div>
                    <div class="table-container">
                        <table id="table-sms">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" onchange="App.UI.toggleSelectAll(this, '#table-sms')"></th>
                                    <th>è®¾å¤‡</th>
                                    <th>å¡æ§½</th>
                                    <th>æ–¹å‘</th>
                                    <th>å¯¹æ–¹å·ç </th>
                                    <th>å†…å®¹</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢ 3: é€šè¯è®°å½• -->
        <div id="panel-calls" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="phone" size="20"></i> é€šè¯è®°å½•</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-danger" onclick="App.Modules.Calls.deleteBatch()">
                            <i data-lucide="trash-2" size="16"></i> åˆ é™¤
                        </button>
                        <button class="btn btn-success" onclick="App.Modules.Calls.export()">
                            <i data-lucide="download" size="16"></i> å¯¼å‡º
                        </button>
                        <button class="btn btn-secondary" onclick="App.Modules.Calls.load()">
                            <i data-lucide="refresh-cw" size="16"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <input type="text" class="form-control" id="call-search" placeholder="æœç´¢å·ç ..." style="flex:1;">
                        <select class="form-control" id="call-slot" style="width: 100px;" onchange="App.Modules.Calls.load()">
                            <option value="">å…¨éƒ¨å¡æ§½</option>
                            <option value="1">å¡æ§½1</option>
                            <option value="2">å¡æ§½2</option>
                        </select>
                        <select class="form-control" id="call-type" style="width: 120px;" onchange="App.Modules.Calls.load()">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="incoming">æ¥ç”µ</option>
                            <option value="outgoing">å»ç”µ</option>
                            <option value="missed">æœªæ¥</option>
                        </select>
                        <input type="date" class="form-control" id="call-date-start" style="width: 140px;" onchange="App.Modules.Calls.load()">
                        <input type="date" class="form-control" id="call-date-end" style="width: 140px;" onchange="App.Modules.Calls.load()">
                        <button class="btn btn-primary" onclick="App.Modules.Calls.load()">æœç´¢</button>
                    </div>
                    <div class="table-container">
                        <table id="table-calls">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" onchange="App.UI.toggleSelectAll(this, '#table-calls')"></th>
                                    <th>è®¾å¤‡</th>
                                    <th>å¡æ§½</th>
                                    <th>æ¶ˆæ¯ç±»å‹</th>
                                    <th>é€šè¯åˆ†ç±»</th>
                                    <th>å¯¹æ–¹å·ç </th>
                                    <th>æ—¶é—´</th>
                                    <th>æ—¶é•¿</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢ 4: æ¶ˆæ¯æ—¥å¿— -->
        <div id="panel-logs" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="file-text" size="20"></i> æ¶ˆæ¯æ—¥å¿—</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-danger" onclick="App.Modules.Logs.deleteBatch()">
                            <i data-lucide="trash-2" size="16"></i> åˆ é™¤
                        </button>
                        <button class="btn btn-success" onclick="App.Modules.Logs.export()">
                            <i data-lucide="download" size="16"></i> å¯¼å‡º
                        </button>
                        <button class="btn btn-secondary" onclick="App.Modules.Logs.load()">
                            <i data-lucide="refresh-cw" size="16"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <select class="form-control" id="log-msg-type" style="flex:1;" onchange="App.Modules.Logs.load()">
                            <option value="">å…¨éƒ¨æ¶ˆæ¯ç±»å‹</option>
                            <optgroup label="æ¶ˆæ¯å¤§ç±»">
                                <option value="network">è”ç½‘æ¶ˆæ¯ (100-102)</option>
                                <option value="sim">SIMå¡æ¶ˆæ¯ (202-209)</option>
                                <option value="sms">çŸ­ä¿¡æ¶ˆæ¯ (501-502)</option>
                                <option value="call">ç”µè¯æ¶ˆæ¯ (601-642)</option>
                                <option value="call_ctrl">ç”µè¯æ§åˆ¶å›åº” (681-689)</option>
                                <option value="command">å‘½ä»¤åº”ç­” (401-402)</option>
                                <option value="module">é€šè®¯æ¨¡ç»„ (301)</option>
                            </optgroup>
                        </select>
                        <input type="date" class="form-control" id="log-date-start" style="width: 140px;" onchange="App.Modules.Logs.load()">
                        <input type="date" class="form-control" id="log-date-end" style="width: 140px;" onchange="App.Modules.Logs.load()">
                        <button class="btn btn-primary" onclick="App.Modules.Logs.load()">æœç´¢</button>
                    </div>
                    <div class="table-container">
                        <table id="table-logs">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" onchange="App.UI.toggleSelectAll(this, '#table-logs')"></th>
                                    <th>è®¾å¤‡</th>
                                    <th>å¡æ§½</th>
                                    <th>æ¶ˆæ¯ç±»å‹</th>
                                    <th>ç±»å‹åç§°</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢ 5: æ§åˆ¶ç»ˆç«¯ -->
        <div id="panel-control" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="terminal" size="20"></i> å‘é€æŒ‡ä»¤</h2>
                </div>
                <div class="card-body">
                    <div style="max-width: 800px;">
                        <div class="search-box" style="flex-direction: column;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">ç›®æ ‡è®¾å¤‡</label>
                                    <select id="ctrl-device-select" class="form-control" onchange="App.Modules.Control.onDeviceSelect()"></select>
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">è®¾å¤‡IP</label>
                                    <input type="text" id="ctrl-device-ip" class="form-control" placeholder="è®¾å¤‡IPåœ°å€">
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%; margin-top: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">å¼€å‘æ¿è´¦å·</label>
                                    <input type="text" id="ctrl-board-user" class="form-control" value="admin" placeholder="admin">
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">å¼€å‘æ¿å¯†ç </label>
                                    <input type="password" id="ctrl-board-pass" class="form-control" value="admin" placeholder="å¯†ç ">
                                </div>
                            </div>
                            
                            <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary); margin-top: 10px;">é€‰æ‹©æŒ‡ä»¤</label>
                            <select id="ctrl-cmd-select" class="form-control" onchange="App.Modules.Control.onCmdSelect()">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                            </select>
                        </div>
                        
                        <div id="ctrl-params-container" style="margin: 20px 0;"></div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="App.Modules.Control.send()">
                                <i data-lucide="send" size="16"></i> å‘é€æŒ‡ä»¤
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">æ‰§è¡Œç»“æœ</label>
                            <pre id="ctrl-result" style="background: #1e293b; color: #a5f3fc; padding: 15px; border-radius: 8px; font-family: monospace; min-height: 100px; margin-top: 5px; white-space: pre-wrap;">ç­‰å¾…æŒ‡ä»¤...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div id="login-overlay" class="login-overlay active">
        <div class="login-card">
            <div class="login-icon-wrap"><i data-lucide="lock" size="32"></i></div>
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <p>è¯·è¾“å…¥æ‚¨çš„å‡­è¯ä»¥è®¿é—®æ§åˆ¶å°</p>
            <div style="display: flex; flex-direction: column; gap: 16px; text-align: left;">
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block;">ç”¨æˆ·å</label>
                    <input type="text" id="login-user" class="form-control" placeholder="admin">
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block;">å¯†ç </label>
                    <input type="password" id="login-pass" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="btn btn-primary" onclick="App.Auth.login()" style="justify-content: center; padding: 12px;">
                    ç™»å½•ç³»ç»Ÿ <i data-lucide="arrow-right" size="16"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡å¼¹çª— -->
    <div id="modal-add-device" class="login-overlay">
        <div class="login-card" style="text-align: left; max-width: 450px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 600;">æ·»åŠ æ–°è®¾å¤‡</h3>
                <button onclick="App.UI.hideModal('modal-add-device')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <input type="text" id="add-dev-id" class="form-control" placeholder="è®¾å¤‡ID (å¿…å¡«)">
                <input type="text" id="add-dev-name" class="form-control" placeholder="è®¾å¤‡åç§°">
                <input type="text" id="add-dev-ip" class="form-control" placeholder="IPåœ°å€">
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="App.UI.hideModal('modal-add-device')">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="App.Modules.Devices.add()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="toast-container"></div>

    <script>
        // åˆå§‹åŒ– Lucide å›¾æ ‡
        lucide.createIcons();

        // ==================== App Namespace (JS Modularization) ====================
        const App = {
            config: {
                apiBase: '', // API åŸºç¡€è·¯å¾„
                authKey: 'iot_auth_token'
            },
            
            // å‘½ä»¤å®šä¹‰
            CMD_PARAMS: {
                'stat': { desc: 'è·å–è®¾å¤‡å½“å‰çŠ¶æ€ä¿¡æ¯', params: [] },
                'restart': { desc: 'é‡å¯å¼€å‘æ¿', params: [] },
                'now': { 
                    desc: 'è®¾ç½®å¼€å‘æ¿æ—¶é—´',
                    params: [
                        { name: 'p1', label: 'æ—¶é—´', placeholder: 'YYYYMMDDHHmmss (ç•™ç©ºè‡ªåŠ¨è·å–)', type: 'text' },
                        { name: 'p3', label: 'æ—¶åŒº', placeholder: '8 (åŒ—äº¬æ—¶é—´)', type: 'number', default: '8' }
                    ]
                },
                'pingsec': { 
                    desc: 'è®¾ç½®Pingæ¶ˆæ¯é—´éš”ç§’æ•°',
                    params: [
                        { name: 'p1', label: 'é—´éš”ç§’æ•°', placeholder: 'æœ€å°10ç§’', type: 'number', required: true }
                    ]
                },
                'dailyrst': { 
                    desc: 'è®¾ç½®æ¯æ—¥è‡ªåŠ¨é‡å¯æ—¶é—´',
                    params: [
                        { name: 'p1', label: 'é‡å¯æ—¶é—´(0-23)', placeholder: '4 (å‡Œæ™¨4ç‚¹)', type: 'number', required: true }
                    ]
                },
                'chpwduser': {
                    desc: 'ä¿®æ”¹ç”¨æˆ·å¯†ç ',
                    params: [
                        { name: 'p1', label: 'æ–°å¯†ç ', placeholder: 'è‡³å°‘4ä½', type: 'text', required: true }
                    ]
                },
                'slotoff': { 
                    desc: 'æŒ‡å®šå¡æ§½å…³æœº',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true }
                    ]
                },
                'slotrst': { 
                    desc: 'æŒ‡å®šå¡æ§½é‡å¯',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true }
                    ]
                },
                'slotplmn': {
                    desc: 'æŒ‡å®šå¡æ³¨å†Œçš„è¿è¥å•†',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                        { name: 'p2', label: 'è¿è¥å•†ä»£ç ', placeholder: 'å¦‚: 46001 (0è¡¨ç¤ºè‡ªåŠ¨)', type: 'number', default: '0' }
                    ]
                },
                'sendsms': { 
                    desc: 'é€šè¿‡æŒ‡å®šå¡æ§½å‘é€çŸ­ä¿¡',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                        { name: 'p2', label: 'ç›®æ ‡å·ç ', placeholder: 'æ‰‹æœºå·ç ', type: 'text', required: true },
                        { name: 'p3', label: 'çŸ­ä¿¡å†…å®¹', placeholder: 'çŸ­ä¿¡å†…å®¹', type: 'textarea', required: true },
                        { name: 'tid', label: 'äº‹åŠ¡ID', placeholder: 'ç”¨äºæ¥æ”¶å‘é€ç»“æœ(å¯é€‰)', type: 'text' }
                    ]
                },
                'querysms': { 
                    desc: 'æŸ¥è¯¢æœ¬åœ°å­˜å‚¨çš„çŸ­ä¿¡è®°å½•',
                    params: [
                        { name: 'p1', label: 'èµ·å§‹ä½ç½®', placeholder: 'ä»ç¬¬å‡ æ¡å¼€å§‹ (é»˜è®¤1)', type: 'number', default: '1' },
                        { name: 'p2', label: 'æŸ¥è¯¢æ¡æ•°', placeholder: 'æŸ¥è¯¢å¤šå°‘æ¡ (é»˜è®¤10)', type: 'number', default: '10' },
                        { name: 'p3', label: 'å…³é”®è¯', placeholder: 'ç­›é€‰å…³é”®è¯(å¯é€‰)', type: 'text' }
                    ]
                },
                'teldial': { 
                    desc: 'ä½¿ç”¨æŒ‡å®šå¡æ§½æ‹¨æ‰“ç”µè¯',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                        { name: 'p2', label: 'ç›®æ ‡å·ç ', placeholder: 'æ‰‹æœºå·ç ', type: 'text', required: true },
                        { name: 'p3', label: 'é€šè¯æ—¶é•¿(ç§’)', placeholder: 'é»˜è®¤175ç§’', type: 'number' },
                        { name: 'p4', label: 'TTSè¯­éŸ³å†…å®¹', placeholder: 'æ‹¨é€šåæ’­æ”¾çš„è¯­éŸ³', type: 'textarea' },
                        { name: 'p5', label: 'TTSæ’­æ”¾æ¬¡æ•°', placeholder: 'é»˜è®¤1æ¬¡', type: 'number' },
                        { name: 'p7', label: 'æ’­å®ŒååŠ¨ä½œ', type: 'select', options: [{v:'0',t:'æ— æ“ä½œ'},{v:'1',t:'æŒ‚æ–­'}] }
                    ]
                },
                'telanswer': { 
                    desc: 'æ¥å¬å½“å‰æ¥ç”µ',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                        { name: 'p2', label: 'é€šè¯æ—¶é•¿(ç§’)', placeholder: 'é»˜è®¤175ç§’', type: 'number' },
                        { name: 'p3', label: 'TTSè¯­éŸ³å†…å®¹', placeholder: 'æ¥é€šåæ’­æ”¾çš„è¯­éŸ³', type: 'textarea' },
                        { name: 'p6', label: 'æ’­å®ŒååŠ¨ä½œ', type: 'select', options: [{v:'0',t:'æ— æ“ä½œ'},{v:'1',t:'æŒ‚æ–­'}] }
                    ]
                },
                'telhangup': { 
                    desc: 'æŒ‚æ–­å½“å‰é€šè¯',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true }
                    ]
                },
                'telstarttts': {
                    desc: 'æ’­æ”¾TTSè¯­éŸ³',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                        { name: 'p2', label: 'TTSå†…å®¹', placeholder: 'è¦æ’­æ”¾çš„è¯­éŸ³å†…å®¹', type: 'textarea', required: true },
                        { name: 'p3', label: 'æ’­æ”¾æ¬¡æ•°', placeholder: '0è¡¨ç¤ºæ— é™å¾ªç¯', type: 'number', default: '1' },
                        { name: 'p4', label: 'æ’­æ”¾é—´éš”(ç§’)', placeholder: 'é»˜è®¤1ç§’', type: 'number', default: '1' },
                        { name: 'p5', label: 'æ’­å®ŒååŠ¨ä½œ', type: 'select', options: [{v:'0',t:'æ— æ“ä½œ'},{v:'1',t:'æŒ‚æ–­'}] }
                    ]
                },
                'telstoptts': {
                    desc: 'åœæ­¢æ’­æ”¾TTSè¯­éŸ³',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                        { name: 'p2', label: 'åœæ­¢ååŠ¨ä½œ', type: 'select', options: [{v:'0',t:'æ— æ“ä½œ'},{v:'1',t:'æŒ‚æ–­'}] }
                    ]
                },
                'telkeypress': {
                    desc: 'å‘é€DTMFæŒ‰é”®',
                    params: [
                        { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                        { name: 'p2', label: 'æŒ‰é”®åºåˆ—', placeholder: 'å¦‚: 123#', type: 'text', required: true },
                        { name: 'p3', label: 'æŒ‰é”®æ—¶é•¿(ms)', placeholder: 'é»˜è®¤200ms', type: 'number', default: '200' },
                        { name: 'p4', label: 'æŒ‰é”®é—´éš”(ms)', placeholder: 'é»˜è®¤100ms', type: 'number', default: '100' }
                    ]
                },
                'querytel': { 
                    desc: 'æŸ¥è¯¢æœ¬åœ°å­˜å‚¨çš„é€šè¯è®°å½•',
                    params: [
                        { name: 'p1', label: 'èµ·å§‹ä½ç½®', placeholder: 'ä»ç¬¬å‡ æ¡å¼€å§‹ (é»˜è®¤1)', type: 'number', default: '1' },
                        { name: 'p2', label: 'æŸ¥è¯¢æ¡æ•°', placeholder: 'æŸ¥è¯¢å¤šå°‘æ¡ (é»˜è®¤10)', type: 'number', default: '10' }
                    ]
                },
                'wf': {
                    desc: 'æ‰“å¼€æˆ–å…³é—­WiFi',
                    params: [
                        { name: 'p1', label: 'åŠ¨ä½œ', type: 'select', options: [{v:'on',t:'æ‰“å¼€'},{v:'off',t:'å…³é—­'}], required: true }
                    ]
                },
                'addwf': { 
                    desc: 'æ·»åŠ å¯è¿æ¥çš„WiFiçƒ­ç‚¹ä¿¡æ¯',
                    params: [
                        { name: 'p1', label: 'WiFiåç§°', placeholder: 'WiFiçƒ­ç‚¹å(2.4G)', type: 'text', required: true },
                        { name: 'p2', label: 'WiFiå¯†ç ', placeholder: 'WiFiå¯†ç ', type: 'text', required: true }
                    ]
                },
                'delwf': { 
                    desc: 'åˆ é™¤å·²ä¿å­˜çš„WiFiçƒ­ç‚¹ä¿¡æ¯',
                    params: [
                        { name: 'p1', label: 'WiFiåç§°', placeholder: 'è¦åˆ é™¤çš„WiFiçƒ­ç‚¹å', type: 'text', required: true }
                    ]
                },
                'dailyota': {
                    desc: 'è®¾ç½®æ¯æ—¥è‡ªåŠ¨å‡çº§æ—¶é—´',
                    params: [
                        { name: 'p1', label: 'å‡çº§æ—¶é—´(0-23)', placeholder: '3 (å‡Œæ™¨3ç‚¹)', type: 'number', required: true }
                    ]
                },
                'otanow': {
                    desc: 'ç«‹å³æ‰§è¡ŒOTAå‡çº§',
                    params: [
                        { name: 'tid', label: 'äº‹åŠ¡ID', placeholder: 'ç”¨äºæ¥æ”¶ç»“æœ(å¯é€‰)', type: 'text' }
                    ]
                }
            },

            // --- è®¤è¯æ¨¡å— ---
            Auth: {
                init() {
                    const token = localStorage.getItem(App.config.authKey);
                    if (token) {
                        document.getElementById('login-overlay').classList.remove('active');
                        document.getElementById('user-menu').style.display = 'flex';
                        App.Modules.Stats.load();
                        App.Modules.Devices.load();
                        App.Modules.Control.init();
                        
                        // å®šæ—¶åˆ·æ–°ç»Ÿè®¡
                        setInterval(() => App.Modules.Stats.load(), 30000);
                    }
                },
                async login() {
                    const user = document.getElementById('login-user').value;
                    const pass = document.getElementById('login-pass').value;
                    if (!user || !pass) return App.UI.toast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');

                    const auth = 'Basic ' + btoa(user + ':' + pass);
                    
                    // éªŒè¯ç™»å½•
                    try {
                        const res = await fetch(`${App.config.apiBase}/api/stats`, {
                            headers: { 'Authorization': auth }
                        });
                        
                        if (res.ok) {
                            localStorage.setItem(App.config.authKey, auth);
                            App.UI.toast('ç™»å½•æˆåŠŸ', 'success');
                            setTimeout(() => location.reload(), 500);
                        } else {
                            App.UI.toast('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                        }
                    } catch (e) {
                        App.UI.toast('ç™»å½•è¯·æ±‚å¤±è´¥', 'error');
                    }
                },
                logout() {
                    localStorage.removeItem(App.config.authKey);
                    location.reload();
                }
            },

            // --- UI å·¥å…· ---
            UI: {
                switchTab(panelId, tabEl) {
                    document.querySelectorAll('.page-panel').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.getElementById('panel-' + panelId).classList.add('active');
                    tabEl.classList.add('active');
                    
                    // æ‡’åŠ è½½æ•°æ®
                    if(panelId === 'sms') App.Modules.SMS.load();
                    if(panelId === 'calls') App.Modules.Calls.load();
                    if(panelId === 'logs') App.Modules.Logs.load();
                },
                toggleSelectAll(source, tableId) {
                    const checkboxes = document.querySelectorAll(`${tableId} tbody input[type="checkbox"]`);
                    checkboxes.forEach(cb => cb.checked = source.checked);
                },
                getSelectedIds(tableId) {
                    const checkboxes = document.querySelectorAll(`${tableId} tbody input[type="checkbox"]:checked`);
                    return Array.from(checkboxes).map(cb => cb.value);
                },
                showModal(id) {
                    document.getElementById(id).classList.add('active');
                },
                hideModal(id) {
                    document.getElementById(id).classList.remove('active');
                },
                toast(msg, type = 'info') {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    el.className = `toast ${type}`;
                    
                    let iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info';
                    
                    el.innerHTML = `
                        <i data-lucide="${iconName}" class="toast-icon" size="20"></i>
                        <span>${msg}</span>
                    `;
                    container.appendChild(el);
                    lucide.createIcons({ root: el });
                    
                    setTimeout(() => {
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(-20px)';
                        setTimeout(() => el.remove(), 300);
                    }, 3000);
                }
            },

            // --- ä¸šåŠ¡æ¨¡å— ---
            Modules: {
                Stats: {
                    async load() {
                        try {
                            const data = await App.Utils.apiFetch('/api/stats');
                            if (data.success) {
                                document.getElementById('stat-devices').textContent = data.data.devices.total;
                                document.getElementById('stat-online-badge').textContent = `${data.data.devices.online} åœ¨çº¿`;
                                document.getElementById('stat-offline-badge').textContent = `${data.data.devices.offline} ç¦»çº¿`;
                                document.getElementById('stat-sms-today').textContent = data.data.sms.today;
                                document.getElementById('stat-sms-total').textContent = data.data.sms.total;
                                document.getElementById('stat-calls-today').textContent = data.data.calls.today;
                                document.getElementById('stat-calls-total').textContent = data.data.calls.total;
                            }
                        } catch (e) {
                            console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥', e);
                        }
                    }
                },
                Devices: {
                    async load() {
                        const tbody = document.querySelector('#table-devices tbody');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">åŠ è½½ä¸­...</td></tr>';
                        
                        try {
                            const data = await App.Utils.apiFetch('/api/devices');
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(d => `
                                    <tr>
                                        <td data-label="è®¾å¤‡ID"><span class="device-id" style="font-weight:600;">${d.dev_id}</span></td>
                                        <td data-label="åç§°">${d.name || '-'}</td>
                                        <td data-label="çŠ¶æ€">
                                            <span class="badge ${d.status === 'online' ? 'badge-success' : 'badge-danger'}">
                                                ${d.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                            </span>
                                        </td>
                                        <td data-label="ç½‘ç»œ">${d.last_ip || '-'}</td>
                                        <td data-label="SIMå¡">${App.Utils.formatSimInfo(d.sim_cards)}</td>
                                        <td data-label="æœ€ååœ¨çº¿" style="color:var(--text-secondary); font-size:12px;">${App.Utils.formatTime(d.last_seen_at)}</td>
                                    </tr>
                                `).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:#888;">æš‚æ— è®¾å¤‡æ•°æ®</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:red;">åŠ è½½å¤±è´¥</td></tr>';
                        }
                    },
                    async refresh() {
                        App.UI.toast('æ­£åœ¨åˆ·æ–°è®¾å¤‡çŠ¶æ€...', 'info');
                        try {
                            await App.Utils.apiFetch('/api/devices/refresh-all', { method: 'POST' });
                            this.load();
                            App.Modules.Stats.load();
                        } catch (e) {
                            App.UI.toast('åˆ·æ–°å¤±è´¥', 'error');
                        }
                    },
                    async add() {
                        const devId = document.getElementById('add-dev-id').value.trim();
                        const name = document.getElementById('add-dev-name').value.trim();
                        const ip = document.getElementById('add-dev-ip').value.trim();
                        
                        if (!devId) return App.UI.toast('è¯·è¾“å…¥è®¾å¤‡ID', 'warning');
                        
                        try {
                            const res = await App.Utils.apiFetch('/api/devices', {
                                method: 'POST',
                                body: JSON.stringify({ devId, name, ip })
                            });
                            if (res.success) {
                                App.UI.toast('è®¾å¤‡æ·»åŠ æˆåŠŸ', 'success');
                                App.UI.hideModal('modal-add-device');
                                this.load();
                                App.Modules.Control.loadDevices();
                            } else {
                                App.UI.toast(res.error || 'æ·»åŠ å¤±è´¥', 'error');
                            }
                        } catch (e) {
                            App.UI.toast('æ·»åŠ å¤±è´¥: ' + e.message, 'error');
                        }
                    }
                },
                SMS: {
                    async load() {
                        const tbody = document.querySelector('#table-sms tbody');
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">åŠ è½½ä¸­...</td></tr>';
                        
                        const phoneNum = document.getElementById('sms-search').value;
                        const direction = document.getElementById('sms-direction').value;
                        const slot = document.getElementById('sms-slot').value;
                        const dateStart = document.getElementById('sms-date-start').value;
                        const dateEnd = document.getElementById('sms-date-end').value;
                        
                        let url = '/api/sms?limit=100';
                        if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                        if (direction) url += `&direction=${direction}`;
                        if (slot) url += `&slot=${slot}`;
                        if (dateStart) url += `&startTime=${dateStart} 00:00:00`;
                        if (dateEnd) url += `&endTime=${dateEnd} 23:59:59`;
                        
                        try {
                            const data = await App.Utils.apiFetch(url);
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(sms => `
                                    <tr>
                                        <td><input type="checkbox" value="${sms.id}"></td>
                                        <td data-label="è®¾å¤‡">${sms.dev_id}</td>
                                        <td data-label="å¡æ§½"><span class="badge badge-neutral">å¡${sms.slot || '?'}</span></td>
                                        <td data-label="æ–¹å‘"><span class="badge ${sms.direction === 'in' ? 'badge-info' : 'badge-success'}">${sms.direction === 'in' ? 'æ¥æ”¶' : 'å‘é€'}</span></td>
                                        <td data-label="å·ç ">${sms.phone_num}</td>
                                        <td data-label="å†…å®¹"><div class="sms-content">${App.Utils.escapeHtml(sms.content)}</div></td>
                                        <td data-label="æ—¶é—´">${App.Utils.formatTime(sms.sms_time || sms.created_at)}</td>
                                    </tr>
                                `).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color:#888;">æš‚æ— çŸ­ä¿¡è®°å½•</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color:red;">åŠ è½½å¤±è´¥</td></tr>';
                        }
                    },
                    async deleteBatch() {
                        const ids = App.UI.getSelectedIds('#table-sms');
                        if (ids.length === 0) return App.UI.toast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'warning');
                        
                        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•å—ï¼Ÿ`)) return;
                        
                        try {
                            const res = await App.Utils.apiFetch('/api/sms/batch-delete', {
                                method: 'POST',
                                body: JSON.stringify({ ids })
                            });
                            if (res.success) {
                                App.UI.toast('åˆ é™¤æˆåŠŸ', 'success');
                                this.load();
                            } else {
                                App.UI.toast('åˆ é™¤å¤±è´¥', 'error');
                            }
                        } catch (e) {
                            App.UI.toast('è¯·æ±‚å¤±è´¥', 'error');
                        }
                    },
                    export() {
                        const phoneNum = document.getElementById('sms-search').value;
                        const direction = document.getElementById('sms-direction').value;
                        const slot = document.getElementById('sms-slot').value;
                        const dateStart = document.getElementById('sms-date-start').value;
                        const dateEnd = document.getElementById('sms-date-end').value;
                        
                        let url = '/api/sms?export=csv';
                        
                        // ä¼˜å…ˆä½¿ç”¨å‹¾é€‰çš„ID
                        const ids = App.UI.getSelectedIds('#table-sms');
                        if (ids.length > 0) {
                            url += `&ids=${ids.join(',')}`;
                        } else {
                            if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                            if (direction) url += `&direction=${direction}`;
                            if (slot) url += `&slot=${slot}`;
                            if (dateStart) url += `&startTime=${dateStart} 00:00:00`;
                            if (dateEnd) url += `&endTime=${dateEnd} 23:59:59`;
                        }
                        
                        const token = localStorage.getItem(App.config.authKey);
                        if (token) url += `&_auth=${encodeURIComponent(token)}`;
                        
                        window.open(App.config.apiBase + url, '_blank');
                    }
                },
                Calls: {
                    async load() {
                        const tbody = document.querySelector('#table-calls tbody');
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">åŠ è½½ä¸­...</td></tr>';
                        
                        const phoneNum = document.getElementById('call-search').value;
                        const callType = document.getElementById('call-type').value;
                        const slot = document.getElementById('call-slot').value;
                        const dateStart = document.getElementById('call-date-start').value;
                        const dateEnd = document.getElementById('call-date-end').value;
                        
                        let url = '/api/calls?limit=100';
                        if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                        if (callType) url += `&callType=${callType}`;
                        if (slot) url += `&slot=${slot}`;
                        if (dateStart) url += `&startTime=${dateStart} 00:00:00`;
                        if (dateEnd) url += `&endTime=${dateEnd} 23:59:59`;
                        
                        try {
                            const data = await App.Utils.apiFetch(url);
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(call => `
                                    <tr>
                                        <td><input type="checkbox" value="${call.id}"></td>
                                        <td data-label="è®¾å¤‡">${call.dev_id}</td>
                                        <td data-label="å¡æ§½"><span class="badge badge-neutral">å¡${call.slot || '?'}</span></td>
                                        <td data-label="æ¶ˆæ¯ç±»å‹">${App.Utils.getCallMsgTypeText(call.msg_type)}</td>
                                        <td data-label="é€šè¯åˆ†ç±»">${App.Utils.getCallTypeText(call.call_type)}</td>
                                        <td data-label="å¯¹æ–¹å·ç ">${call.phone_num}</td>
                                        <td data-label="æ—¶é—´">${App.Utils.formatTime(call.start_time)}</td>
                                        <td data-label="æ—¶é•¿">${App.Utils.formatDuration(call.duration)}</td>
                                    </tr>
                                `).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color:#888;">æš‚æ— é€šè¯è®°å½•</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color:red;">åŠ è½½å¤±è´¥</td></tr>';
                        }
                    },
                    async deleteBatch() {
                        const ids = App.UI.getSelectedIds('#table-calls');
                        if (ids.length === 0) return App.UI.toast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'warning');
                        
                        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•å—ï¼Ÿ`)) return;
                        
                        try {
                            const res = await App.Utils.apiFetch('/api/calls/batch-delete', {
                                method: 'POST',
                                body: JSON.stringify({ ids })
                            });
                            if (res.success) {
                                App.UI.toast('åˆ é™¤æˆåŠŸ', 'success');
                                this.load();
                            } else {
                                App.UI.toast('åˆ é™¤å¤±è´¥', 'error');
                            }
                        } catch (e) {
                            App.UI.toast('è¯·æ±‚å¤±è´¥', 'error');
                        }
                    },
                    export() {
                        const phoneNum = document.getElementById('call-search').value;
                        const callType = document.getElementById('call-type').value;
                        const slot = document.getElementById('call-slot').value;
                        const dateStart = document.getElementById('call-date-start').value;
                        const dateEnd = document.getElementById('call-date-end').value;
                        
                        let url = '/api/calls?export=csv';
                        
                        // ä¼˜å…ˆä½¿ç”¨å‹¾é€‰çš„ID
                        const ids = App.UI.getSelectedIds('#table-calls');
                        if (ids.length > 0) {
                            url += `&ids=${ids.join(',')}`;
                        } else {
                            if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                            if (callType) url += `&callType=${callType}`;
                            if (slot) url += `&slot=${slot}`;
                            if (dateStart) url += `&startTime=${dateStart} 00:00:00`;
                            if (dateEnd) url += `&endTime=${dateEnd} 23:59:59`;
                        }
                        
                        const token = localStorage.getItem(App.config.authKey);
                        if (token) url += `&_auth=${encodeURIComponent(token)}`;
                        
                        window.open(App.config.apiBase + url, '_blank');
                    }
                },
                Logs: {
                    async load() {
                        const tbody = document.querySelector('#table-logs tbody');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">åŠ è½½ä¸­...</td></tr>';
                        
                        const msgType = document.getElementById('log-msg-type').value;
                        const dateStart = document.getElementById('log-date-start').value;
                        const dateEnd = document.getElementById('log-date-end').value;
                        
                        let url = '/api/messages?limit=100';
                        if (msgType) {
                            if (isNaN(msgType)) url += `&msgCategory=${msgType}`;
                            else url += `&msgType=${msgType}`;
                        }
                        if (dateStart) url += `&startTime=${dateStart} 00:00:00`;
                        if (dateEnd) url += `&endTime=${dateEnd} 23:59:59`;
                        
                        try {
                            const data = await App.Utils.apiFetch(url);
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(log => {
                                    let slot = '-';
                                    try {
                                        if (log.raw_data) {
                                            const raw = JSON.parse(log.raw_data);
                                            if (raw.slot) slot = 'å¡' + raw.slot;
                                            else if (raw.slotInfo) slot = 'å¤šå¡ä¿¡æ¯';
                                        }
                                    } catch(e) {}
                                    
                                    return `
                                    <tr>
                                        <td><input type="checkbox" value="${log.id}"></td>
                                        <td data-label="è®¾å¤‡">${log.dev_id}</td>
                                        <td data-label="å¡æ§½"><span class="badge badge-neutral">${slot}</span></td>
                                        <td data-label="æ¶ˆæ¯ç±»å‹">${log.type}</td>
                                        <td data-label="ç±»å‹åç§°">${log.type_name}</td>
                                        <td data-label="æ—¶é—´">${App.Utils.formatTime(log.created_at)}</td>
                                    </tr>
                                `}).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:#888;">æš‚æ— æ¶ˆæ¯æ—¥å¿—</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:red;">åŠ è½½å¤±è´¥</td></tr>';
                        }
                    },
                    async deleteBatch() {
                        const ids = App.UI.getSelectedIds('#table-logs');
                        if (ids.length === 0) return App.UI.toast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'warning');
                        
                        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•å—ï¼Ÿ`)) return;
                        
                        try {
                            const res = await App.Utils.apiFetch('/api/messages/batch-delete', {
                                method: 'POST',
                                body: JSON.stringify({ ids })
                            });
                            if (res.success) {
                                App.UI.toast('åˆ é™¤æˆåŠŸ', 'success');
                                this.load();
                            } else {
                                App.UI.toast('åˆ é™¤å¤±è´¥', 'error');
                            }
                        } catch (e) {
                            App.UI.toast('è¯·æ±‚å¤±è´¥', 'error');
                        }
                    },
                    export() {
                        const msgType = document.getElementById('log-msg-type').value;
                        const dateStart = document.getElementById('log-date-start').value;
                        const dateEnd = document.getElementById('log-date-end').value;
                        
                        let url = '/api/messages?export=csv';
                        
                        // ä¼˜å…ˆä½¿ç”¨å‹¾é€‰çš„ID
                        const ids = App.UI.getSelectedIds('#table-logs');
                        if (ids.length > 0) {
                            url += `&ids=${ids.join(',')}`;
                        } else {
                            if (msgType) {
                                if (isNaN(msgType)) url += `&msgCategory=${msgType}`;
                                else url += `&msgType=${msgType}`;
                            }
                            if (dateStart) url += `&startTime=${dateStart} 00:00:00`;
                            if (dateEnd) url += `&endTime=${dateEnd} 23:59:59`;
                        }
                        
                        const token = localStorage.getItem(App.config.authKey);
                        if (token) url += `&_auth=${encodeURIComponent(token)}`;
                        
                        window.open(App.config.apiBase + url, '_blank');
                    }
                },
                Control: {
                    init() {
                        this.loadDevices();
                        this.renderCmdOptions();
                    },
                    async loadDevices() {
                        try {
                            const data = await App.Utils.apiFetch('/api/devices');
                            const select = document.getElementById('ctrl-device-select');
                            select.innerHTML = '';
                            
                            if (data.success && data.data.length > 0) {
                                data.data.forEach(device => {
                                    const option = document.createElement('option');
                                    option.value = device.dev_id;
                                    option.dataset.ip = device.last_ip || '';
                                    option.textContent = `${device.name || device.dev_id} (${device.last_ip || 'æœªçŸ¥IP'})`;
                                    select.appendChild(option);
                                });
                                this.onDeviceSelect();
                            }
                        } catch (e) {
                            console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥', e);
                        }
                    },
                    renderCmdOptions() {
                        const select = document.getElementById('ctrl-cmd-select');
                        select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                        for (const [key, val] of Object.entries(App.CMD_PARAMS)) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = `${val.desc} (${key})`;
                            select.appendChild(option);
                        }
                    },
                    onDeviceSelect() {
                        const select = document.getElementById('ctrl-device-select');
                        const selectedOption = select.options[select.selectedIndex];
                        if (selectedOption) {
                            document.getElementById('ctrl-device-ip').value = selectedOption.dataset.ip || '';
                        }
                    },
                    onCmdSelect() {
                        const cmd = document.getElementById('ctrl-cmd-select').value;
                        const container = document.getElementById('ctrl-params-container');
                        container.innerHTML = '';
                        
                        if (!cmd || !App.CMD_PARAMS[cmd]) return;
                        
                        const cmdInfo = App.CMD_PARAMS[cmd];
                        
                        if (cmdInfo.params.length > 0) {
                            let html = '<div class="form-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">';
                            cmdInfo.params.forEach(param => {
                                html += `<div class="form-group" style="display:flex; flex-direction:column; gap:5px;">`;
                                html += `<label style="font-size:13px; color:var(--text-secondary);">${param.label}${param.required ? ' *' : ''}</label>`;
                                
                                if (param.type === 'select') {
                                    html += `<select class="form-control" data-param="${param.name}">`;
                                    param.options.forEach(opt => {
                                        html += `<option value="${opt.v}">${opt.t}</option>`;
                                    });
                                    html += `</select>`;
                                } else if (param.type === 'textarea') {
                                    html += `<textarea class="form-control" data-param="${param.name}" placeholder="${param.placeholder || ''}" rows="3">${param.default || ''}</textarea>`;
                                } else {
                                    html += `<input type="${param.type || 'text'}" class="form-control" data-param="${param.name}" placeholder="${param.placeholder || ''}" value="${param.default || ''}">`;
                                }
                                html += `</div>`;
                            });
                            html += '</div>';
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = `<div style="color:var(--text-secondary); font-size:13px;">æ­¤æŒ‡ä»¤æ— é¢å¤–å‚æ•°</div>`;
                        }
                    },
                    async send() {
                        const deviceIp = document.getElementById('ctrl-device-ip').value.trim();
                        const cmd = document.getElementById('ctrl-cmd-select').value;
                        const devId = document.getElementById('ctrl-device-select').value;
                        const user = document.getElementById('ctrl-board-user').value.trim();
                        const pass = document.getElementById('ctrl-board-pass').value.trim();
                        
                        if (!deviceIp) return App.UI.toast('è¯·è¾“å…¥è®¾å¤‡IP', 'error');
                        if (!cmd) return App.UI.toast('è¯·é€‰æ‹©æŒ‡ä»¤', 'warning');
                        if (!user || !pass) return App.UI.toast('è¯·è¾“å…¥å¼€å‘æ¿è´¦å·å’Œå¯†ç ', 'warning');
                        
                        // è‡ªåŠ¨è®¡ç®— Token
                        const raw = `${devId}|${user}|${pass}`;
                        const msgBuffer = new TextEncoder().encode(raw);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
                        const token = hashHex.substring(16, 48);
                        
                        const params = {};
                        document.querySelectorAll('#ctrl-params-container [data-param]').forEach(el => {
                            const val = el.value.trim();
                            if (val) params[el.dataset.param] = val;
                        });
                        
                        const resultBox = document.getElementById('ctrl-result');
                        resultBox.className = 'result-box';
                        resultBox.textContent = `[${new Date().toLocaleTimeString()}] æ­£åœ¨å‘é€ ${cmd} æŒ‡ä»¤...`;
                        
                        try {
                            const res = await App.Utils.apiFetch('/api/control/send', {
                                method: 'POST',
                                body: JSON.stringify({ deviceIp, token, cmd, params })
                            });
                            
                            if (res.success) {
                                resultBox.className = 'result-box success'; // Note: style needs to be defined or inline
                                resultBox.style.color = '#a7f3d0';
                                resultBox.textContent = `âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ\n\n` +
                                    `ğŸ“¡ è¯·æ±‚URL:\n${res.command?.url || 'æ— '}\n\n` +
                                    `ğŸ“¥ è®¾å¤‡å“åº”:\n${JSON.stringify(res.data, null, 2)}`;
                                App.UI.toast('æŒ‡ä»¤å‘é€æˆåŠŸ', 'success');
                            } else {
                                throw new Error(res.error || 'æœªçŸ¥é”™è¯¯');
                            }
                        } catch (e) {
                            resultBox.className = 'result-box error'; // Note: style needs to be defined or inline
                            resultBox.style.color = '#fecaca';
                            resultBox.textContent = `âŒ æ‰§è¡Œå¤±è´¥: ${e.message}`;
                            App.UI.toast('æŒ‡ä»¤å‘é€å¤±è´¥', 'error');
                        }
                    }
                }
            },
            
            // --- è¾…åŠ©å‡½æ•° ---
            Utils: {
                async apiFetch(url, options = {}) {
                    const token = localStorage.getItem(App.config.authKey);
                    const headers = {
                        'Content-Type': 'application/json',
                        ...options.headers
                    };
                    if (token) headers['Authorization'] = token;
                    
                    const res = await fetch(App.config.apiBase + url, { ...options, headers });
                    if (res.status === 401) {
                        App.Auth.logout();
                        throw new Error('æœªæˆæƒ');
                    }
                    return res.json();
                },
                formatTime(timeStr) {
                    if (!timeStr) return '-';
                    // å¦‚æœæ˜¯æ—¶é—´æˆ³ï¼ˆçº¯æ•°å­—ï¼‰
                    if (/^\d+$/.test(timeStr)) {
                        try {
                            // å‡è®¾æ˜¯UTCæ—¶é—´æˆ³ï¼Œ+8å°æ—¶è½¬åŒ—äº¬æ—¶é—´
                            const ts = parseInt(timeStr) * 1000;
                            const date = new Date(ts + 8 * 3600 * 1000);
                            const pad = n => n < 10 ? '0' + n : n;
                            return `${date.getUTCFullYear()}-${pad(date.getUTCMonth() + 1)}-${pad(date.getUTCDate())} ${pad(date.getUTCHours())}:${pad(date.getUTCMinutes())}:${pad(date.getUTCSeconds())}`;
                        } catch (e) { return timeStr; }
                    }
                    // å¦‚æœæ˜¯ISOå­—ç¬¦ä¸²ï¼Œå°è¯•è½¬æ¢
                    try {
                        const date = new Date(timeStr);
                        // ç®€å•å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºæœ¬åœ°æ—¶é—´ï¼ˆå‡è®¾æµè§ˆå™¨åœ¨ä¸­å›½ï¼‰
                        // æˆ–è€…æ‰‹åŠ¨å¤„ç†æ—¶åŒº
                        return date.toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
                    } catch (e) { return timeStr; }
                },
                formatSimInfo(simCards) {
                    if (!simCards || simCards.length === 0) return '-';
                    return simCards.map(sim => {
                        const statusClass = sim.status === 'ready' ? 'badge-success' : 'badge-danger';
                        return `<span class="badge ${statusClass}" style="margin-right:5px;">å¡${sim.slot}: ${sim.msisdn || 'æœªçŸ¥'}</span>`;
                    }).join('');
                },
                escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                getCallTypeText(type) {
                    const map = { 'incoming': 'ğŸ“ æ¥ç”µ', 'outgoing': 'ğŸ“± å»ç”µ', 'missed': 'âŒ æœªæ¥' };
                    return map[type] || type;
                },
                getCallMsgTypeText(type) {
                    const map = {
                        601: 'ğŸ“³ æ¥ç”µæŒ¯é“ƒ', 602: 'âœ… æ¥ç”µæ¥é€š', 603: 'ğŸ“´ å¯¹æ–¹æŒ‚æ–­',
                        620: 'ğŸ“² å»ç”µæ‹¨å·', 621: 'ğŸ“³ å¯¹æ–¹æŒ¯é“ƒ', 622: 'âœ… å»ç”µæ¥é€š', 623: 'ğŸ“´ å»ç”µæŒ‚æ–­'
                    };
                    return map[type] || type;
                },
                formatDuration(seconds) {
                    if (!seconds) return '-';
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return m > 0 ? `${m}åˆ†${s}ç§’` : `${s}ç§’`;
                }
            }
        };

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', App.Auth.init);

    </script>
</body>
</html>