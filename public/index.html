<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#667eea">
    <title>IoTè®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 500;
        }
        
        .header p {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 600;
            color: #333;
        }
        
        .stat-card .sub-stats {
            margin-top: 10px;
            font-size: 13px;
            color: #888;
        }
        
        .stat-card .online {
            color: #10b981;
        }
        
        .stat-card .offline {
            color: #ef4444;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: #f3f4f6;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 16px;
            font-weight: 500;
        }
        
        .card-body {
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f9fafb;
            font-weight: 500;
            font-size: 13px;
            color: #666;
        }
        
        td {
            font-size: 14px;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-online {
            background: #d1fae5;
            color: #059669;
        }
        
        .status-offline {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .refresh-btn {
            background: #f3f4f6;
            color: #333;
        }
        
        .refresh-btn:hover {
            background: #e5e7eb;
        }
        
        .sms-content {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .device-id {
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .empty-message {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .search-box input, .search-box select, .search-box button {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .search-box input[type="text"] {
            flex: 1;
            min-width: 150px;
        }
        
        .search-box input[type="date"] {
            min-width: 140px;
        }
        
        .search-box select {
            min-width: 120px;
        }
        
        /* æ¶ˆæ¯æ—¥å¿—çš„æ¶ˆæ¯ç±»å‹é€‰æ‹©å™¨éœ€è¦æ›´å®½ */
        #log-msg-type {
            min-width: 200px;
        }

        .sim-info {
            font-size: 12px;
            color: #666;
        }

        .sim-info .sim-slot {
            display: inline-block;
            padding: 2px 6px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-right: 5px;
        }

        .sim-info .sim-slot.ready {
            background: #d1fae5;
            color: #059669;
        }

        .sim-info .sim-slot.error {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* æ§åˆ¶æŒ‡ä»¤é¢æ¿æ ·å¼ */
        .control-form {
            max-width: 900px;
        }
        
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section h3 {
            font-size: 15px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group small {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .cmd-params {
            margin-top: 15px;
        }
        
        .cmd-params .param-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .form-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .result-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-box.success {
            background: #064e3b;
            color: #a7f3d0;
        }
        
        .result-box.error {
            background: #7f1d1d;
            color: #fecaca;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            font-size: 18px;
            font-weight: 500;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body .form-group {
            margin-bottom: 15px;
        }
        
        .modal-body .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }
        
        .modal-body .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-body .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* ç™»å½•é®ç½© */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .login-card {
            background: white;
            padding: 35px 30px;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.25);
            width: 100%;
            max-width: 380px;
            text-align: center;
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-card .login-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
        }
        
        .login-card h2 {
            margin-bottom: 8px;
            color: #333;
            font-size: 22px;
            font-weight: 600;
        }
        
        .login-card p {
            color: #888;
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        .login-form-group {
            text-align: left;
            margin-bottom: 18px;
        }
        
        .login-form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }
        
        .login-form-group .input-wrapper {
            position: relative;
        }
        
        .login-form-group .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            font-size: 16px;
            pointer-events: none;
        }
        
        .login-form-group input {
            width: 100%;
            padding: 14px 14px 14px 42px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
            background: #fafafa;
        }
        
        .login-form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .login-form-group input::placeholder {
            color: #bbb;
        }
        
        .login-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .login-options label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #666;
            cursor: pointer;
            user-select: none;
        }
        
        .login-options input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-btn .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        
        .login-btn.loading .spinner {
            display: block;
        }
        
        .login-btn.loading .btn-text {
            display: none;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 18px;
            font-size: 13px;
            display: none;
            text-align: left;
        }
        
        .login-error.show {
            display: flex;
            align-items: center;
            gap: 8px;
            animation: shake 0.4s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .login-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
            color: #999;
            font-size: 12px;
        }

        /* æ‰¹é‡æ“ä½œå·¥å…·æ  */
        .batch-toolbar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .batch-toolbar.hidden {
            display: none;
        }
        
        .batch-toolbar .select-info {
            font-size: 14px;
            color: #666;
        }
        
        .batch-toolbar .select-info strong {
            color: #667eea;
        }
        
        .batch-toolbar .batch-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        /* è¡¨æ ¼å¤é€‰æ¡† */
        .row-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        th .row-checkbox {
            margin-right: 5px;
        }
        
        tr.selected {
            background: #eef2ff !important;
        }
        
        /* ç¡®è®¤å¼¹çª— */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .confirm-modal.active {
            display: flex;
        }
        
        .confirm-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .confirm-content .confirm-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .confirm-content h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .confirm-content p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .confirm-actions .btn {
            min-width: 100px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .header {
                padding: 15px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .container {
                padding: 10px;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                padding: 8px 15px;
                font-size: 14px;
                flex-shrink: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .card-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .card-header > div {
                width: 100%;
                display: flex;
                gap: 10px;
            }
            
            .card-header .btn {
                flex: 1;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .search-box input, .search-box select, .search-box button {
                width: 100%;
            }
            
            .table-responsive {
                overflow-x: visible; /* å…è®¸å¡ç‰‡æº¢å‡ºå®¹å™¨ï¼ˆè™½ç„¶å¡ç‰‡æœ¬èº«æ˜¯å—çº§ï¼‰ */
            }
            
            table {
                min-width: 0;
                display: block;
            }
            
            thead {
                display: none; /* éšè—è¡¨å¤´ */
            }
            
            tbody {
                display: block;
            }
            
            tr {
                display: block;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                margin-bottom: 15px;
                padding: 15px;
                border: 1px solid #e5e7eb;
                position: relative;
            }
            
            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #f3f4f6;
                text-align: right;
                font-size: 14px;
            }
            
            td:last-child {
                border-bottom: none;
            }
            
            td::before {
                font-weight: 600;
                color: #666;
                margin-right: 15px;
                text-align: left;
                flex-shrink: 0;
            }
            
            /* å¤é€‰æ¡†åˆ—ç‰¹æ®Šå¤„ç† */
            #sms-table td:first-child,
            #calls-table td:first-child,
            #logs-table td:first-child {
                justify-content: flex-start;
                border-bottom: 1px solid #f3f4f6;
                padding-bottom: 10px;
                margin-bottom: 5px;
            }
            
            #sms-table td:first-child::before,
            #calls-table td:first-child::before,
            #logs-table td:first-child::before {
                content: "é€‰æ‹©";
            }

            /* ç©ºæ•°æ®/åŠ è½½ä¸­è¡Œç‰¹æ®Šå¤„ç† */
            td.loading, td.empty-message {
                border: none;
                justify-content: center;
                width: 100%;
                padding: 20px 0;
            }
            
            td.loading::before, td.empty-message::before {
                content: none !important;
            }

            /* çŸ­ä¿¡è¡¨æ ¼é€‚é… */
            #sms-table td:nth-of-type(2)::before { content: "è®¾å¤‡/SIM"; }
            #sms-table td:nth-of-type(3)::before { content: "æ–¹å‘"; }
            #sms-table td:nth-of-type(4)::before { content: "å¯¹æ–¹å·ç "; }
            #sms-table td:nth-of-type(5)::before { content: "å†…å®¹"; }
            #sms-table td:nth-of-type(6)::before { content: "æ—¶é—´"; }
            
            /* çŸ­ä¿¡å†…å®¹ç‰¹æ®Šå¤„ç† */
            #sms-table td:nth-of-type(5) {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #sms-table td:nth-of-type(5) .sms-content {
                white-space: normal;
                max-width: 100%;
                margin-top: 5px;
                text-align: left;
            }

            /* é€šè¯è¡¨æ ¼é€‚é… */
            #calls-table td:nth-of-type(2)::before { content: "è®¾å¤‡/SIM"; }
            #calls-table td:nth-of-type(3)::before { content: "æ¶ˆæ¯ç±»å‹"; }
            #calls-table td:nth-of-type(4)::before { content: "é€šè¯åˆ†ç±»"; }
            #calls-table td:nth-of-type(5)::before { content: "å¯¹æ–¹å·ç "; }
            #calls-table td:nth-of-type(6)::before { content: "æ—¶é—´"; }
            #calls-table td:nth-of-type(7)::before { content: "æ—¶é•¿"; }

            /* æ—¥å¿—è¡¨æ ¼é€‚é… */
            #logs-table td:nth-of-type(2)::before { content: "è®¾å¤‡/SIM"; }
            #logs-table td:nth-of-type(3)::before { content: "æ¶ˆæ¯ç±»å‹"; }
            #logs-table td:nth-of-type(4)::before { content: "ç±»å‹åç§°"; }
            #logs-table td:nth-of-type(5)::before { content: "æ—¶é—´"; }
            
            /* è®¾å¤‡è¡¨æ ¼é€‚é… */
            #devices-table td:nth-of-type(1)::before { content: "è®¾å¤‡ID"; }
            #devices-table td:nth-of-type(2)::before { content: "åç§°"; }
            #devices-table td:nth-of-type(3)::before { content: "çŠ¶æ€"; }
            #devices-table td:nth-of-type(4)::before { content: "IPåœ°å€"; }
            #devices-table td:nth-of-type(5)::before { content: "WiFi"; }
            #devices-table td:nth-of-type(6)::before { content: "SIMå¡"; }
            #devices-table td:nth-of-type(7)::before { content: "æœ€ååœ¨çº¿"; }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            /* ç§»åŠ¨ç«¯ç™»å½•é¡µé¢ä¼˜åŒ– */
            .login-overlay {
                align-items: flex-start;
                padding-top: 60px;
            }
            
            .login-card {
                padding: 30px 24px;
                border-radius: 16px;
                max-width: 100%;
            }
            
            .login-card .login-icon {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
            
            .login-card h2 {
                font-size: 20px;
            }
            
            .login-form-group input {
                padding: 12px 12px 12px 40px;
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }
            
            .login-btn {
                padding: 13px;
            }
            
            /* ç§»åŠ¨ç«¯å¼¹çª—ä¼˜åŒ– */
            .modal-content {
                margin: 15px;
                max-width: calc(100% - 30px);
                max-height: calc(100vh - 100px);
                overflow-y: auto;
            }
            
            .header-top {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .logout-btn {
                width: 100%;
                text-align: center;
                margin-left: 0;
            }
        }
        
        /* å°å±æ‰‹æœºé€‚é… */
        @media (max-width: 380px) {
            .login-card {
                padding: 25px 20px;
            }
            
            .login-card h2 {
                font-size: 18px;
            }
            
            .login-form-group input {
                padding: 11px 11px 11px 38px;
            }
            
            .stats-grid {
                gap: 8px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card .value {
                font-size: 26px;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            .login-overlay {
                padding: 15px;
                align-items: center;
            }
            
            .login-card {
                padding: 20px;
            }
            
            .login-card .login-icon {
                width: 50px;
                height: 50px;
                font-size: 24px;
                margin-bottom: 15px;
            }
            
            .login-card h2 {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .login-card p {
                margin-bottom: 15px;
            }
            
            .login-form-group {
                margin-bottom: 12px;
            }
            
            .login-footer {
                margin-top: 15px;
                padding-top: 15px;
            }
        }
        
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .logout-btn:active {
            transform: translateY(0);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255,255,255,0.9);
            font-size: 13px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div>
                <h1>ğŸ”§ IoTè®¾å¤‡ç®¡ç†ç³»ç»Ÿ</h1>
                <p>è®¾å¤‡ç®¡ç† Â· çŸ­ä¿¡è®°å½• Â· é€šè¯è®°å½•</p>
            </div>
            <div class="user-info" id="user-info" style="display: none;">
                <div class="user-avatar">ğŸ‘¤</div>
                <span id="current-user">ç®¡ç†å‘˜</span>
                <button class="logout-btn" onclick="doLogout()" id="logout-btn">
                    <span>ğŸšª</span>
                    <span>é€€å‡º</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>è®¾å¤‡æ€»æ•°</h3>
                <div class="value" id="stat-devices">-</div>
                <div class="sub-stats">
                    <span class="online" id="stat-online">0 åœ¨çº¿</span> / 
                    <span class="offline" id="stat-offline">0 ç¦»çº¿</span>
                </div>
            </div>
            <div class="stat-card">
                <h3>çŸ­ä¿¡æ€»æ•°</h3>
                <div class="value" id="stat-sms">-</div>
                <div class="sub-stats">ä»Šæ—¥: <span id="stat-sms-today">0</span></div>
            </div>
            <div class="stat-card">
                <h3>é€šè¯æ€»æ•°</h3>
                <div class="value" id="stat-calls">-</div>
                <div class="sub-stats">ä»Šæ—¥: <span id="stat-calls-today">0</span></div>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" data-panel="devices">è®¾å¤‡åˆ—è¡¨</button>
            <button class="tab" data-panel="sms">çŸ­ä¿¡è®°å½•</button>
            <button class="tab" data-panel="calls">é€šè¯è®°å½•</button>
            <button class="tab" data-panel="logs">æ¶ˆæ¯æ—¥å¿—</button>
            <button class="tab" data-panel="control">æ§åˆ¶æŒ‡ä»¤</button>
        </div>
        
        <!-- è®¾å¤‡åˆ—è¡¨é¢æ¿ -->
        <div id="devices" class="panel active">
            <div class="card">
                <div class="card-header">
                    <h2>è®¾å¤‡åˆ—è¡¨</h2>
                    <div>
                        <button class="btn btn-primary" onclick="showAddDeviceModal()">â• æ·»åŠ è®¾å¤‡</button>
                        <button class="btn refresh-btn" onclick="refreshAndLoadDevices()" id="refresh-devices-btn">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>è®¾å¤‡ID</th>
                                    <th>åç§°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>IPåœ°å€</th>
                                    <th>WiFi</th>
                                    <th>SIMå¡ä¿¡æ¯</th>
                                    <th>æœ€ååœ¨çº¿</th>
                                </tr>
                            </thead>
                            <tbody id="devices-table">
                                <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çŸ­ä¿¡è®°å½•é¢æ¿ -->
        <div id="sms" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2>çŸ­ä¿¡è®°å½•</h2>
                    <div>
                        <button class="btn btn-success" onclick="exportData('sms')">ğŸ“¥ å¯¼å‡º</button>
                        <button class="btn refresh-btn" onclick="loadSms()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <input type="text" id="sms-search" placeholder="æœç´¢å·ç ...">
                        <select id="sms-direction">
                            <option value="">å…¨éƒ¨æ–¹å‘</option>
                            <option value="in">æ”¶åˆ°</option>
                            <option value="out">å‘å‡º</option>
                        </select>
                        <input type="date" id="sms-date-start" placeholder="å¼€å§‹æ—¥æœŸ">
                        <input type="date" id="sms-date-end" placeholder="ç»“æŸæ—¥æœŸ">
                        <button class="btn btn-primary" onclick="loadSms()">æœç´¢</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearSmsFilter()">æ¸…ç©º</button>
                    </div>
                    <div id="sms-batch-toolbar" class="batch-toolbar hidden">
                        <div class="select-info">å·²é€‰æ‹© <strong id="sms-selected-count">0</strong> æ¡è®°å½•</div>
                        <div class="batch-actions">
                            <button class="btn btn-success btn-sm" onclick="exportSelected('sms')">ğŸ“¥ å¯¼å‡ºé€‰ä¸­</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete('sms')">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearSelection('sms')">å–æ¶ˆé€‰æ‹©</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:40px;"><input type="checkbox" class="row-checkbox" id="sms-select-all" onchange="toggleSelectAll('sms')"></th>
                                    <th>è®¾å¤‡/SIMå¡</th>
                                    <th>æ–¹å‘</th>
                                    <th>å¯¹æ–¹å·ç </th>
                                    <th>å†…å®¹</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="sms-table">
                                <tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é€šè¯è®°å½•é¢æ¿ -->
        <div id="calls" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2>é€šè¯è®°å½•</h2>
                    <div>
                        <button class="btn btn-success" onclick="exportData('calls')">ğŸ“¥ å¯¼å‡º</button>
                        <button class="btn refresh-btn" onclick="loadCalls()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <input type="text" id="call-search" placeholder="æœç´¢å·ç ...">
                        <select id="call-type">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="incoming">æ¥ç”µ</option>
                            <option value="outgoing">å»ç”µ</option>
                            <option value="missed">æœªæ¥</option>
                        </select>
                        <input type="date" id="call-date-start" placeholder="å¼€å§‹æ—¥æœŸ">
                        <input type="date" id="call-date-end" placeholder="ç»“æŸæ—¥æœŸ">
                        <button class="btn btn-primary" onclick="loadCalls()">æœç´¢</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearCallsFilter()">æ¸…ç©º</button>
                    </div>
                    <div id="calls-batch-toolbar" class="batch-toolbar hidden">
                        <div class="select-info">å·²é€‰æ‹© <strong id="calls-selected-count">0</strong> æ¡è®°å½•</div>
                        <div class="batch-actions">
                            <button class="btn btn-success btn-sm" onclick="exportSelected('calls')">ğŸ“¥ å¯¼å‡ºé€‰ä¸­</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete('calls')">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearSelection('calls')">å–æ¶ˆé€‰æ‹©</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:40px;"><input type="checkbox" class="row-checkbox" id="calls-select-all" onchange="toggleSelectAll('calls')"></th>
                                    <th>è®¾å¤‡/SIMå¡</th>
                                    <th>æ¶ˆæ¯ç±»å‹</th>
                                    <th>é€šè¯åˆ†ç±»</th>
                                    <th>å¯¹æ–¹å·ç </th>
                                    <th>æ—¶é—´</th>
                                    <th>æ—¶é•¿</th>
                                </tr>
                            </thead>
                            <tbody id="calls-table">
                                <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æ—¥å¿—é¢æ¿ -->
        <div id="logs" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2>æ¶ˆæ¯æ—¥å¿—</h2>
                    <div>
                        <button class="btn btn-success" onclick="exportData('logs')">ğŸ“¥ å¯¼å‡º</button>
                        <button class="btn refresh-btn" onclick="loadLogs()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <select id="log-msg-type">
                            <option value="">å…¨éƒ¨æ¶ˆæ¯ç±»å‹</option>
                            <optgroup label="â”â” æŒ‰å¤§ç±»ç­›é€‰ â”â”">
                                <option value="network">ğŸ“¡ æ‰€æœ‰è”ç½‘æ¶ˆæ¯ (100-102)</option>
                                <option value="sim">ğŸ“± æ‰€æœ‰SIMå¡æ¶ˆæ¯ (202-209)</option>
                                <option value="sms">ğŸ’¬ æ‰€æœ‰çŸ­ä¿¡æ¶ˆæ¯ (501-502)</option>
                                <option value="call">ğŸ“ æ‰€æœ‰ç”µè¯æ¶ˆæ¯ (601-642)</option>
                                <option value="call_ctrl">ğŸ›ï¸ æ‰€æœ‰ç”µè¯æ§åˆ¶ (681-689)</option>
                                <option value="command">âš™ï¸ æ‰€æœ‰å‘½ä»¤åº”ç­” (401-402)</option>
                                <option value="module">ğŸ”Œ é€šè®¯æ¨¡ç»„æ¶ˆæ¯ (301)</option>
                            </optgroup>
                            <optgroup label="â”â” è”ç½‘æ¶ˆæ¯ â”â”">
                                <option value="100">ã€€100 - WIFIå·²è”ç½‘</option>
                                <option value="101">ã€€101 - å¡æ§½1å·²è”ç½‘</option>
                                <option value="102">ã€€102 - å¡æ§½2å·²è”ç½‘</option>
                            </optgroup>
                            <optgroup label="â”â” SIMå¡æ¶ˆæ¯ â”â”">
                                <option value="202">ã€€202 - SIMå¡åŸºç«™æ³¨å†Œä¸­</option>
                                <option value="203">ã€€203 - SIMå¡IDå·²è·å–</option>
                                <option value="204">ã€€204 - SIMå¡å·²å°±ç»ª</option>
                                <option value="205">ã€€205 - SIMå¡å·²å¼¹å‡º</option>
                                <option value="209">ã€€209 - SIMå¡å¼‚å¸¸</option>
                            </optgroup>
                            <optgroup label="â”â” çŸ­ä¿¡æ¶ˆæ¯ â”â”">
                                <option value="501">ã€€501 - æ–°çŸ­ä¿¡</option>
                                <option value="502">ã€€502 - çŸ­ä¿¡å¤–å‘æˆåŠŸ</option>
                            </optgroup>
                            <optgroup label="â”â” ç”µè¯æ¶ˆæ¯ â”â”">
                                <option value="601">ã€€601 - æ¥ç”µæŒ¯é“ƒ</option>
                                <option value="602">ã€€602 - æ¥ç”µæ¥é€š</option>
                                <option value="603">ã€€603 - å¯¹æ–¹æŒ‚æ–­æ¥ç”µ</option>
                                <option value="620">ã€€620 - å»ç”µæ‹¨å·ä¸­</option>
                                <option value="621">ã€€621 - å»ç”µå¯¹æ–¹æŒ¯é“ƒä¸­</option>
                                <option value="622">ã€€622 - å»ç”µå·²æ¥é€š</option>
                                <option value="623">ã€€623 - å»ç”µå·²æŒ‚æ–­</option>
                                <option value="641">ã€€641 - é€šè¯ä¸­æœ¬åœ°æŒ‰é”®</option>
                                <option value="642">ã€€642 - é€šè¯ä¸­è¿œç¨‹æŒ‰é”®</option>
                            </optgroup>
                            <optgroup label="â”â” ç”µè¯æ§åˆ¶åº”ç­” â”â”">
                                <option value="681">ã€€681 - å¤–å‘¼æ‹¨å·æˆåŠŸ</option>
                                <option value="682">ã€€682 - å¤–å‘¼æ‹¨å·å¤±è´¥</option>
                                <option value="684">ã€€684 - æ¥å¬æˆåŠŸ</option>
                                <option value="685">ã€€685 - æ¥å¬å¤±è´¥</option>
                                <option value="687">ã€€687 - TTSæ’­æ”¾æˆåŠŸ</option>
                                <option value="688">ã€€688 - TTSæ’­æ”¾å¤±è´¥</option>
                                <option value="689">ã€€689 - TTSæ’­æ”¾ç»“æŸ</option>
                            </optgroup>
                            <optgroup label="â”â” å…¶ä»–æ¶ˆæ¯ â”â”">
                                <option value="301">ã€€301 - é€šè®¯æ¨¡ç»„é”™è¯¯</option>
                                <option value="401">ã€€401 - å‘½ä»¤å·²æ”¶åˆ°</option>
                                <option value="402">ã€€402 - å‘½ä»¤å·²å¤„ç†</option>
                            </optgroup>
                        </select>
                        <input type="date" id="log-date-start" placeholder="å¼€å§‹æ—¥æœŸ">
                        <input type="date" id="log-date-end" placeholder="ç»“æŸæ—¥æœŸ">
                        <button class="btn btn-primary" onclick="loadLogs()">æœç´¢</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearLogsFilter()">æ¸…ç©º</button>
                    </div>
                    <div id="logs-batch-toolbar" class="batch-toolbar hidden">
                        <div class="select-info">å·²é€‰æ‹© <strong id="logs-selected-count">0</strong> æ¡è®°å½•</div>
                        <div class="batch-actions">
                            <button class="btn btn-success btn-sm" onclick="exportSelected('logs')">ğŸ“¥ å¯¼å‡ºé€‰ä¸­</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete('logs')">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearSelection('logs')">å–æ¶ˆé€‰æ‹©</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:40px;"><input type="checkbox" class="row-checkbox" id="logs-select-all" onchange="toggleSelectAll('logs')"></th>
                                    <th>è®¾å¤‡/SIMå¡</th>
                                    <th>æ¶ˆæ¯ç±»å‹</th>
                                    <th>ç±»å‹åç§°</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table">
                                <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶æŒ‡ä»¤é¢æ¿ -->
        <div id="control" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“¡ å‘å¼€å‘æ¿å‘é€æ§åˆ¶æŒ‡ä»¤</h2>
                </div>
                <div class="card-body">
                    <div class="control-form">
                        <div class="form-section">
                            <h3>è®¾å¤‡è¿æ¥ä¿¡æ¯</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="ctrl-device">é€‰æ‹©è®¾å¤‡</label>
                                    <select id="ctrl-device" onchange="onDeviceSelect()">
                                        <option value="">-- é€‰æ‹©è®¾å¤‡ --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="ctrl-ip">è®¾å¤‡IPåœ°å€ *</label>
                                    <input type="text" id="ctrl-ip" placeholder="å¦‚: 192.168.1.100">
                                </div>
                                <div class="form-group">
                                    <label for="ctrl-admin-user">ç®¡ç†å‘˜è´¦å·</label>
                                    <input type="text" id="ctrl-admin-user" placeholder="å¼€å‘æ¿ç®¡ç†å‘˜è´¦å·">
                                </div>
                                <div class="form-group">
                                    <label for="ctrl-admin-pass">ç®¡ç†å‘˜å¯†ç </label>
                                    <input type="password" id="ctrl-admin-pass" placeholder="å¼€å‘æ¿ç®¡ç†å‘˜å¯†ç ">
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="ctrl-token">Token (å¯é€‰)</label>
                                    <input type="text" id="ctrl-token" placeholder="è¾“å…¥è´¦å·å¯†ç å¯è‡ªåŠ¨è®¡ç®—ï¼Œæˆ–ç›´æ¥ç²˜è´´Token">
                                    <small>ç™»å½•å¼€å‘æ¿åå° â†’ å¯†ç ç®¡ç† â†’ å¤åˆ¶Tokenï¼Œæˆ–è¾“å…¥è´¦å·å¯†ç è‡ªåŠ¨è®¡ç®—</small>
                                </div>
                            </div>
                            
                            <!-- Token è®¡ç®—å™¨ -->
                            <div class="token-calculator" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1;">
                                <h4 style="font-size: 14px; color: #475569; margin-bottom: 12px;">ğŸ” Token è®¡ç®—å™¨</h4>
                                <div class="form-grid" style="gap: 10px;">
                                    <div class="form-group">
                                        <label for="calc-dev-id">å¼€å‘æ¿è®¾å¤‡ID</label>
                                        <input type="text" id="calc-dev-id" placeholder="å¦‚: AAAA1234">
                                    </div>
                                    <div class="form-group">
                                        <label for="calc-admin-user">ç®¡ç†å‘˜è´¦å·</label>
                                        <input type="text" id="calc-admin-user" placeholder="å¼€å‘æ¿ç®¡ç†å‘˜è´¦å·">
                                    </div>
                                    <div class="form-group">
                                        <label for="calc-admin-pass">ç®¡ç†å‘˜å¯†ç </label>
                                        <input type="password" id="calc-admin-pass" placeholder="å¼€å‘æ¿ç®¡ç†å‘˜å¯†ç ">
                                    </div>
                                </div>
                                <div style="margin-top: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <button class="btn btn-primary btn-sm" onclick="calculateToken()">ğŸ§® è®¡ç®—Token</button>
                                    <button class="btn btn-secondary btn-sm" onclick="fillTokenToInput()">ğŸ“‹ å¡«å…¥ä¸Šæ–¹</button>
                                    <span id="calc-token-result" style="font-family: monospace; font-size: 13px; color: #059669; word-break: break-all;"></span>
                                </div>
                                <small style="display: block; margin-top: 8px; color: #94a3b8;">è®¡ç®—è§„åˆ™: SHA256(è®¾å¤‡ID|ç®¡ç†å‘˜è´¦å·|ç®¡ç†å‘˜å¯†ç )</small>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>æ§åˆ¶å‘½ä»¤</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="ctrl-cmd">é€‰æ‹©å‘½ä»¤ *</label>
                                    <select id="ctrl-cmd" onchange="onCommandSelect()">
                                        <option value="">-- é€‰æ‹©å‘½ä»¤ --</option>
                                        <optgroup label="è®¾å¤‡æ§åˆ¶">
                                            <option value="stat">stat - è·å–è®¾å¤‡çŠ¶æ€</option>
                                            <option value="restart">restart - é‡å¯è®¾å¤‡</option>
                                            <option value="now">now - è®¾ç½®æ—¶é—´</option>
                                            <option value="pingsec">pingsec - è®¾ç½®Pingé—´éš”</option>
                                            <option value="dailyrst">dailyrst - è®¾ç½®æ¯æ—¥é‡å¯æ—¶é—´</option>
                                        </optgroup>
                                        <optgroup label="å¡æ§½æ§åˆ¶">
                                            <option value="slotoff">slotoff - æŒ‡å®šå¡æ§½å…³æœº</option>
                                            <option value="slotrst">slotrst - æŒ‡å®šå¡æ§½é‡å¯</option>
                                        </optgroup>
                                        <optgroup label="çŸ­ä¿¡">
                                            <option value="sendsms">sendsms - å‘é€çŸ­ä¿¡</option>
                                            <option value="querysms">querysms - æŸ¥è¯¢æœ¬åœ°çŸ­ä¿¡</option>
                                        </optgroup>
                                        <optgroup label="ç”µè¯">
                                            <option value="teldial">teldial - æ‹¨æ‰“ç”µè¯</option>
                                            <option value="telanswer">telanswer - æ¥å¬æ¥ç”µ</option>
                                            <option value="telhangup">telhangup - æŒ‚æ–­ç”µè¯</option>
                                            <option value="querytel">querytel - æŸ¥è¯¢é€šè¯è®°å½•</option>
                                        </optgroup>
                                        <optgroup label="WIFI">
                                            <option value="addwf">addwf - æ·»åŠ WiFiçƒ­ç‚¹</option>
                                            <option value="delwf">delwf - åˆ é™¤WiFiçƒ­ç‚¹</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="cmd-params" class="cmd-params"></div>
                            
                            <div class="form-actions">
                                <button class="btn btn-primary" onclick="sendCommand()">ğŸš€ å‘é€å‘½ä»¤</button>
                                <button class="btn refresh-btn" onclick="clearResult()">æ¸…ç©ºç»“æœ</button>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>æ‰§è¡Œç»“æœ</h3>
                            <pre id="ctrl-result" class="result-box">ç­‰å¾…å‘é€å‘½ä»¤...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ è®¾å¤‡å¼¹çª— -->
    <div id="add-device-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• æ·»åŠ è®¾å¤‡</h3>
                <button class="modal-close" onclick="hideAddDeviceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>è®¾å¤‡ID <span style="color: #ef4444">*</span></label>
                    <input type="text" id="add-dev-id" placeholder="å¦‚: AAAA1234" required>
                </div>
                <div class="form-group">
                    <label>è®¾å¤‡åç§°</label>
                    <input type="text" id="add-dev-name" placeholder="å¦‚: åŠå…¬å®¤è®¾å¤‡1">
                </div>
                <div class="form-group">
                    <label>è®¾å¤‡IPåœ°å€</label>
                    <input type="text" id="add-dev-ip" placeholder="å¦‚: 192.168.1.100">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addDevice()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- ç™»å½•é®ç½© -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-card">
            <div class="login-icon">ğŸ”</div>
            <h2>IoTè®¾å¤‡ç®¡ç†ç³»ç»Ÿ</h2>
            <p>è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·å¯†ç ç™»å½•</p>
            
            <div id="login-error" class="login-error">
                <span>âš ï¸</span>
                <span id="login-error-text">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</span>
            </div>
            
            <div class="login-form-group">
                <label for="login-username">ç”¨æˆ·å</label>
                <div class="input-wrapper">
                    <span class="input-icon">ğŸ‘¤</span>
                    <input type="text" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username" autocapitalize="off">
                </div>
            </div>
            
            <div class="login-form-group">
                <label for="login-password">å¯†ç </label>
                <div class="input-wrapper">
                    <span class="input-icon">ğŸ”‘</span>
                    <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
                </div>
            </div>
            
            <div class="login-options">
                <label>
                    <input type="checkbox" id="remember-login" checked>
                    <span>è®°ä½ç™»å½•çŠ¶æ€</span>
                </label>
            </div>
            
            <button class="btn btn-primary login-btn" id="login-btn" onclick="doLogin()">
                <span class="spinner"></span>
                <span class="btn-text">ç™» å½•</span>
            </button>
            
            <div class="login-footer">
                å®‰å…¨è®¿é—® Â· æ•°æ®åŠ å¯†ä¼ è¾“
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤å¼¹çª— -->
    <div id="confirm-modal" class="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-icon">âš ï¸</div>
            <h3>ç¡®è®¤åˆ é™¤</h3>
            <p id="confirm-message">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" onclick="hideConfirmModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirm-delete-btn" onclick="executeDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';  // ç›¸å¯¹è·¯å¾„
        
        // ==================== è®¤è¯ç®¡ç† ====================
        
        const AUTH_KEY = 'iot_server_auth';
        const REMEMBER_KEY = 'iot_remember_login';
        const USERNAME_KEY = 'iot_saved_username';
        const TOKEN_KEY = 'iot_device_token';
        
        // å°è£…å¸¦é‰´æƒçš„ fetch
        async function apiFetch(url, options = {}) {
            const headers = options.headers || {};
            const auth = localStorage.getItem(AUTH_KEY) || sessionStorage.getItem(AUTH_KEY);
            
            // å¦‚æœæœ‰ä¿å­˜çš„å‡­æ®ï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
            if (auth) {
                // å¦‚æœ headers æ˜¯ Headers å¯¹è±¡
                if (headers instanceof Headers) {
                    headers.append('Authorization', auth);
                } else {
                    // å¦‚æœ headers æ˜¯æ™®é€šå¯¹è±¡
                    headers['Authorization'] = auth;
                }
            }
            
            // ç¡®ä¿ headers è¢«è®¾ç½®å› options
            options.headers = headers;
            
            try {
                const res = await fetch(url, options);
                
                // å¤„ç† 401 æœªæˆæƒ
                if (res.status === 401) {
                    console.warn('è®¤è¯å¤±è´¥: 401 Unauthorized');
                    doLogout(false); // ä¸åˆ·æ–°é¡µé¢ï¼Œåªæ˜¾ç¤ºç™»å½•æ¡†
                    showLoginError('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    throw new Error('Unauthorized');
                }
                
                return res;
            } catch (error) {
                throw error;
            }
        }
        
        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            const errorText = document.getElementById('login-error-text');
            errorText.textContent = message;
            errorDiv.classList.add('show');
        }
        
        function hideLoginError() {
            const errorDiv = document.getElementById('login-error');
            errorDiv.classList.remove('show');
        }
        
        function setLoginLoading(loading) {
            const btn = document.getElementById('login-btn');
            if (loading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
        
        function checkLogin() {
            const auth = localStorage.getItem(AUTH_KEY) || sessionStorage.getItem(AUTH_KEY);
            const overlay = document.getElementById('login-overlay');
            const userInfo = document.getElementById('user-info');
            
            // æ¢å¤ä¿å­˜çš„ç”¨æˆ·å
            const savedUsername = localStorage.getItem(USERNAME_KEY);
            if (savedUsername) {
                document.getElementById('login-username').value = savedUsername;
            }
            
            // æ¢å¤è®°ä½ç™»å½•é€‰é¡¹
            const remember = localStorage.getItem(REMEMBER_KEY);
            if (remember !== null) {
                document.getElementById('remember-login').checked = remember === 'true';
            }
            
            if (auth) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
                userInfo.style.display = 'flex';
                
                // æ˜¾ç¤ºå½“å‰ç”¨æˆ·å
                const currentUser = savedUsername || 'ç®¡ç†å‘˜';
                document.getElementById('current-user').textContent = currentUser;
                
                return true;
            } else {
                overlay.style.display = 'flex';
                overlay.style.opacity = '1';
                userInfo.style.display = 'none';
                // èšç„¦åˆ°ç”¨æˆ·åæˆ–å¯†ç è¾“å…¥æ¡†
                setTimeout(() => {
                    if (savedUsername) {
                        document.getElementById('login-password').focus();
                    } else {
                        document.getElementById('login-username').focus();
                    }
                }, 100);
                return false;
            }
        }
        
        async function doLogin() {
            const user = document.getElementById('login-username').value.trim();
            const pass = document.getElementById('login-password').value.trim();
            const remember = document.getElementById('remember-login').checked;
            
            hideLoginError();
            
            if (!user) {
                showLoginError('è¯·è¾“å…¥ç”¨æˆ·å');
                document.getElementById('login-username').focus();
                return;
            }
            
            if (!pass) {
                showLoginError('è¯·è¾“å…¥å¯†ç ');
                document.getElementById('login-password').focus();
                return;
            }
            
            // ç”Ÿæˆ Basic Auth å‡­æ®
            const auth = 'Basic ' + btoa(user + ':' + pass);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            setLoginLoading(true);
            
            try {
                // éªŒè¯å‡­æ®
                const res = await fetch(`${API_BASE}/api/stats`, {
                    headers: { 'Authorization': auth }
                });
                
                if (res.status === 401) {
                    showLoginError('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                    document.getElementById('login-password').value = '';
                    document.getElementById('login-password').focus();
                    return;
                }
                
                if (!res.ok) {
                    showLoginError('æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    return;
                }
                
                // ç™»å½•æˆåŠŸï¼Œä¿å­˜å‡­æ®
                if (remember) {
                    localStorage.setItem(AUTH_KEY, auth);
                    localStorage.setItem(USERNAME_KEY, user);
                } else {
                    sessionStorage.setItem(AUTH_KEY, auth);
                    localStorage.removeItem(AUTH_KEY);
                }
                localStorage.setItem(REMEMBER_KEY, remember.toString());
                
                // æ˜¾ç¤ºç™»å½•æˆåŠŸ
                checkLogin();
                
                // åŠ è½½æ•°æ®
                loadStats();
                loadDevices();
                loadDevicesForControl();
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showLoginError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            } finally {
                setLoginLoading(false);
            }
        }
        
        function doLogout(reload = true) {
            localStorage.removeItem(AUTH_KEY);
            sessionStorage.removeItem(AUTH_KEY);
            // ä¿ç•™ç”¨æˆ·åå’Œè®°ä½é€‰é¡¹
            if (reload) {
                location.reload();
            } else {
                checkLogin();
            }
        }

        // ç›‘å¬å›è½¦é”®ç™»å½•
        document.getElementById('login-username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-password').focus();
            }
        });
        
        document.getElementById('login-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                doLogin();
            }
        });
        
        // è¾“å…¥æ—¶æ¸…é™¤é”™è¯¯æç¤º
        document.getElementById('login-username').addEventListener('input', hideLoginError);
        document.getElementById('login-password').addEventListener('input', hideLoginError);
        
        // ==================== æ—¶é—´æ ¼å¼åŒ–å·¥å…· ====================
        
        /**
         * æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå¯è¯»æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
         * å¼€å‘æ¿æ¨é€çš„æ—¶é—´æˆ³æ˜¯æŒ‰åŒ—äº¬æ—¶é—´ç”Ÿæˆçš„ï¼ˆå³å¼€å‘æ¿ç”¨æœ¬åœ°æ—¶é—´è®¡ç®—çš„Unixæ—¶é—´æˆ³ï¼‰
         * æ‰€ä»¥è¿™ä¸ªæ—¶é—´æˆ³æ¯”æ ‡å‡†UTCæ—¶é—´æˆ³å¤šäº†8å°æ—¶ï¼Œéœ€è¦è¡¥å¿
         * @param {string|number|Date} dateInput - æ—¥æœŸè¾“å…¥ï¼ˆæ—¶é—´æˆ³æˆ–å­—ç¬¦ä¸²ï¼‰
         * @returns {string} æ ¼å¼åŒ–åçš„åŒ—äº¬æ—¶é—´å­—ç¬¦ä¸²
         */
        function formatBeijingTime(dateInput) {
            if (!dateInput) return '-';
            
            // å¤„ç†ä¸åŒçš„è¾“å…¥æ ¼å¼
            if (typeof dateInput === 'number') {
                // Unixæ—¶é—´æˆ³ï¼ˆç§’æˆ–æ¯«ç§’ï¼‰
                // å¼€å‘æ¿æ¨é€çš„æ—¶é—´æˆ³æ˜¯ç”¨åŒ—äº¬æ—¶é—´è®¡ç®—çš„ï¼Œæ‰€ä»¥å®é™…ä¸Šæ¯”çœŸæ­£çš„UTCæ—¶é—´æˆ³å¤šäº†8å°æ—¶
                // ä¸ºäº†æ­£ç¡®æ˜¾ç¤ºï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒå½“ä½œåŒ—äº¬æ—¶é—´æ¥å¤„ç†
                const ts = dateInput < 10000000000 ? dateInput * 1000 : dateInput;
                
                // ç”±äºæ—¶é—´æˆ³æ˜¯æŒ‰åŒ—äº¬æ—¶é—´ç”Ÿæˆçš„ï¼Œç›´æ¥ç”¨Dateè§£æä¼šè¢«å½“ä½œUTC
                // æˆ‘ä»¬åŠ ä¸Š8å°æ—¶çš„åç§»ï¼Œç„¶åç”¨UTCæ–¹æ³•æ˜¾ç¤ºï¼Œæ•ˆæœå°±æ˜¯æ˜¾ç¤ºåŒ—äº¬æ—¶é—´
                const date = new Date(ts + 8 * 60 * 60 * 1000);
                
                if (isNaN(date.getTime())) return '-';
                
                // ç”¨UTCæ–¹æ³•è·å–æ—¶é—´ï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»åŠ äº†8å°æ—¶åç§»ï¼‰
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } else if (typeof dateInput === 'string') {
                // å¦‚æœå·²ç»æ˜¯æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼ (YYYY-MM-DD HH:MM:SS)ï¼Œç›´æ¥è¿”å›
                if (dateInput.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
                    return dateInput;
                }
                // å°è¯•è§£æä¸ºæ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰
                const num = Number(dateInput);
                if (!isNaN(num)) {
                    return formatBeijingTime(num);
                }
                // ISOæ ¼å¼æˆ–å…¶ä»–å­—ç¬¦ä¸²æ ¼å¼ï¼Œå¯èƒ½æ¥è‡ªæœåŠ¡å™¨çš„created_at
                // æœåŠ¡å™¨æ˜¯UTCæ—¶åŒºï¼Œcreated_atå­˜å‚¨çš„æ˜¯UTCæ—¶é—´ï¼Œéœ€è¦è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return '-';
                
                // åŠ 8å°æ—¶è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
                const beijingDate = new Date(date.getTime() + 8 * 60 * 60 * 1000);
                
                const year = beijingDate.getUTCFullYear();
                const month = String(beijingDate.getUTCMonth() + 1).padStart(2, '0');
                const day = String(beijingDate.getUTCDate()).padStart(2, '0');
                const hours = String(beijingDate.getUTCHours()).padStart(2, '0');
                const minutes = String(beijingDate.getUTCMinutes()).padStart(2, '0');
                const seconds = String(beijingDate.getUTCSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } else {
                return '-';
            }
        }
        
        /**
         * æ ¼å¼åŒ–SIMå¡ä¿¡æ¯æ˜¾ç¤º
         * @param {number} slot - å¡æ§½å·
         * @param {string} msisdn - æ‰‹æœºå·ç 
         * @returns {string} HTMLå­—ç¬¦ä¸²
         */
        function formatSimInfo(slot, msisdn) {
            const slotText = slot ? `å¡${slot}` : '';
            const phoneText = msisdn || '';
            if (slotText || phoneText) {
                return `<span class="sim-slot">${slotText}${phoneText ? ': ' + phoneText : ''}</span>`;
            }
            return '';
        }
        
        /**
         * æ ¼å¼åŒ–è®¾å¤‡å’ŒSIMå¡ä¿¡æ¯
         * @param {string} devId - è®¾å¤‡ID
         * @param {number} slot - å¡æ§½å·
         * @param {string} msisdn - æ‰‹æœºå·ç 
         * @returns {string} HTMLå­—ç¬¦ä¸²
         */
        function formatDeviceSimInfo(devId, slot, msisdn) {
            let html = `<span class="device-id">${devId}</span>`;
            if (slot) {
                html += `<br><span class="sim-slot">å¡${slot}${msisdn ? ': ' + msisdn : ''}</span>`;
            }
            return html;
        }
        
        // ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
        
        // è®°å½•æ¯ä¸ªé¢æ¿æ˜¯å¦å·²åŠ è½½è¿‡æ•°æ®
        const panelLoaded = {
            devices: false,
            sms: false,
            calls: false,
            logs: false,
            control: false
        };
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                const panelId = tab.dataset.panel;
                document.getElementById(panelId).classList.add('active');
                
                // åˆ‡æ¢åˆ°é¢æ¿æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡åŠ è½½è¿‡ï¼‰
                if (!panelLoaded[panelId]) {
                    switch (panelId) {
                        case 'devices':
                            loadDevices();
                            break;
                        case 'sms':
                            loadSms();
                            break;
                        case 'calls':
                            loadCalls();
                            break;
                        case 'logs':
                            loadLogs();
                            break;
                        case 'control':
                            // æ§åˆ¶é¢æ¿ä¸éœ€è¦è‡ªåŠ¨åŠ è½½
                            break;
                    }
                    panelLoaded[panelId] = true;
                }
            });
        });
        
        // ==================== åŠ è½½ç»Ÿè®¡æ•°æ® ====================
        
        async function loadStats() {
            try {
                const res = await apiFetch(`${API_BASE}/api/stats`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('stat-devices').textContent = data.data.devices.total;
                    document.getElementById('stat-online').textContent = `${data.data.devices.online} åœ¨çº¿`;
                    document.getElementById('stat-offline').textContent = `${data.data.devices.offline} ç¦»çº¿`;
                    document.getElementById('stat-sms').textContent = data.data.sms.total;
                    document.getElementById('stat-sms-today').textContent = data.data.sms.today;
                    document.getElementById('stat-calls').textContent = data.data.calls.total;
                    document.getElementById('stat-calls-today').textContent = data.data.calls.today;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // ==================== åŠ è½½è®¾å¤‡åˆ—è¡¨ ====================
        
        async function loadDevices() {
            const tbody = document.getElementById('devices-table');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const res = await apiFetch(`${API_BASE}/api/devices`);
                const data = await res.json();
                
                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(device => `
                        <tr>
                            <td><span class="device-id">${device.dev_id}</span></td>
                            <td>${device.name || '-'}</td>
                            <td>
                                <span class="status-badge ${device.status === 'online' ? 'status-online' : 'status-offline'}">
                                    ${device.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                </span>
                            </td>
                            <td>${device.last_ip || '-'}</td>
                            <td>${device.last_ssid || '-'} ${device.last_dbm ? `(${device.last_dbm}%)` : ''}</td>
                            <td>
                                <div class="sim-info">
                                    ${device.sim_cards && device.sim_cards.length > 0 
                                        ? device.sim_cards.map(sim => `
                                            <span class="sim-slot ${sim.status === 'ready' ? 'ready' : sim.status === 'error' ? 'error' : ''}">
                                                å¡${sim.slot}: ${sim.msisdn || (sim.iccid ? sim.iccid.slice(-6) : 'æœªçŸ¥')}
                                            </span>
                                        `).join(' ')
                                        : '-'
                                    }
                                </div>
                            </td>
                            <td>${formatBeijingTime(device.last_seen_at)}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-message">æš‚æ— è®¾å¤‡æ•°æ®</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="empty-message">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // åˆ·æ–°è®¾å¤‡çŠ¶æ€å¹¶é‡æ–°åŠ è½½åˆ—è¡¨
        async function refreshAndLoadDevices() {
            const btn = document.getElementById('refresh-devices-btn');
            const originalText = btn.textContent;
            btn.textContent = 'â³ åˆ·æ–°ä¸­...';
            btn.disabled = true;
            
            try {
                await refreshAllDeviceStatus();
                await loadDevices();
                loadStats();
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // ==================== æ·»åŠ è®¾å¤‡åŠŸèƒ½ ====================
        
        function showAddDeviceModal() {
            document.getElementById('add-device-modal').classList.add('active');
            document.getElementById('add-dev-id').value = '';
            document.getElementById('add-dev-name').value = '';
            document.getElementById('add-dev-ip').value = '';
            document.getElementById('add-dev-id').focus();
        }
        
        function hideAddDeviceModal() {
            document.getElementById('add-device-modal').classList.remove('active');
        }
        
        async function addDevice() {
            const devId = document.getElementById('add-dev-id').value.trim();
            const name = document.getElementById('add-dev-name').value.trim();
            const ip = document.getElementById('add-dev-ip').value.trim();
            
            if (!devId) {
                alert('è¯·è¾“å…¥è®¾å¤‡ID');
                return;
            }
            
            try {
                const res = await apiFetch(`${API_BASE}/api/devices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ devId, name, ip })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('è®¾å¤‡æ·»åŠ æˆåŠŸ');
                    hideAddDeviceModal();
                    loadDevices();
                    loadDevicesForControl();
                    loadStats();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ·»åŠ è®¾å¤‡å¤±è´¥:', error);
                alert('æ·»åŠ è®¾å¤‡å¤±è´¥: ' + error.message);
            }
        }
        
        // ESC é”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideAddDeviceModal();
            }
        });
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('add-device-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                hideAddDeviceModal();
            }
        });
        
        // ==================== åŠ è½½çŸ­ä¿¡è®°å½• ====================
        
        // å­˜å‚¨å½“å‰æ•°æ®ç”¨äºå¯¼å‡º
        let currentSmsData = [];
        let currentCallsData = [];
        let currentLogsData = [];
        
        async function loadSms() {
            const tbody = document.getElementById('sms-table');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
            clearSelection('sms');
            
            const phoneNum = document.getElementById('sms-search').value;
            const direction = document.getElementById('sms-direction').value;
            const dateStart = document.getElementById('sms-date-start').value;
            const dateEnd = document.getElementById('sms-date-end').value;
            
            try {
                let url = `${API_BASE}/api/sms?limit=100`;
                if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                if (direction) url += `&direction=${direction}`;
                if (dateStart) url += `&dateStart=${dateStart}`;
                if (dateEnd) url += `&dateEnd=${dateEnd}`;
                
                const res = await apiFetch(url);
                const data = await res.json();
                
                if (data.success && data.data.length > 0) {
                    currentSmsData = data.data;
                    tbody.innerHTML = data.data.map(sms => `
                        <tr data-id="${sms.id}">
                            <td><input type="checkbox" class="row-checkbox" onchange="onRowSelect('sms')"></td>
                            <td>${formatDeviceSimInfo(sms.dev_id, sms.slot, sms.msisdn)}</td>
                            <td>${sms.direction === 'in' ? 'ğŸ“¥ æ”¶åˆ°' : 'ğŸ“¤ å‘å‡º'}</td>
                            <td>${sms.phone_num}</td>
                            <td><div class="sms-content" title="${escapeHtml(sms.content)}">${escapeHtml(sms.content)}</div></td>
                            <td>${formatBeijingTime(sms.sms_time || sms.created_at)}</td>
                        </tr>
                    `).join('');
                } else {
                    currentSmsData = [];
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-message">æš‚æ— çŸ­ä¿¡è®°å½•</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½çŸ­ä¿¡å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-message">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // ==================== åŠ è½½é€šè¯è®°å½• ====================
        
        async function loadCalls() {
            const tbody = document.getElementById('calls-table');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
            clearSelection('calls');
            
            const phoneNum = document.getElementById('call-search').value;
            const callType = document.getElementById('call-type').value;
            const dateStart = document.getElementById('call-date-start').value;
            const dateEnd = document.getElementById('call-date-end').value;
            
            try {
                let url = `${API_BASE}/api/calls?limit=100`;
                if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                if (callType) url += `&callType=${callType}`;
                if (dateStart) url += `&dateStart=${dateStart}`;
                if (dateEnd) url += `&dateEnd=${dateEnd}`;
                
                const res = await apiFetch(url);
                const data = await res.json();
                
                if (data.success && data.data.length > 0) {
                    currentCallsData = data.data;
                    tbody.innerHTML = data.data.map(call => `
                        <tr data-id="${call.id}">
                            <td><input type="checkbox" class="row-checkbox" onchange="onRowSelect('calls')"></td>
                            <td>${formatDeviceSimInfo(call.dev_id, call.slot, call.msisdn)}</td>
                            <td>${getCallMsgTypeText(call.msg_type || 603)}</td>
                            <td>${getCallTypeText(call.call_type)}</td>
                            <td>${call.phone_num}</td>
                            <td>${formatBeijingTime(call.start_time)}</td>
                            <td>${formatDuration(call.duration)}</td>
                        </tr>
                    `).join('');
                } else {
                    currentCallsData = [];
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-message">æš‚æ— é€šè¯è®°å½•</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½é€šè¯å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="empty-message">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // ==================== åŠ è½½æ¶ˆæ¯æ—¥å¿— ====================
        
        async function loadLogs() {
            const tbody = document.getElementById('logs-table');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>';
            clearSelection('logs');
            
            const msgTypeValue = document.getElementById('log-msg-type').value;
            const dateStart = document.getElementById('log-date-start').value;
            const dateEnd = document.getElementById('log-date-end').value;
            
            try {
                let url = `${API_BASE}/api/messages?limit=100`;
                
                // åˆ¤æ–­æ˜¯æŒ‰å¤§ç±»ç­›é€‰è¿˜æ˜¯å…·ä½“ç±»å‹ç­›é€‰
                if (msgTypeValue) {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå¤§ç±»(éæ•°å­—)
                    if (isNaN(msgTypeValue)) {
                        url += `&msgCategory=${msgTypeValue}`;
                    } else {
                        url += `&msgType=${msgTypeValue}`;
                    }
                }
                
                if (dateStart) url += `&dateStart=${dateStart}`;
                if (dateEnd) url += `&dateEnd=${dateEnd}`;
                
                const res = await apiFetch(url);
                const data = await res.json();
                
                if (data.success && data.data.length > 0) {
                    currentLogsData = data.data;
                    tbody.innerHTML = data.data.map(log => {
                        // å°è¯•ä»raw_dataä¸­è§£æslotã€msisdnå’ŒmsgTs
                        let slot = '';
                        let msisdn = '';
                        let msgTs = null;
                        try {
                            const rawData = JSON.parse(log.raw_data || '{}');
                            slot = rawData.slot || '';
                            msisdn = rawData.msIsdn || '';
                            msgTs = rawData.msgTs || null;
                        } catch (e) {}
                        
                        return `
                            <tr data-id="${log.id}">
                                <td><input type="checkbox" class="row-checkbox" onchange="onRowSelect('logs')"></td>
                                <td>${formatDeviceSimInfo(log.dev_id, slot, msisdn)}</td>
                                <td>${log.type}</td>
                                <td>${log.type_name}</td>
                                <td>${formatBeijingTime(msgTs || log.created_at)}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    currentLogsData = [];
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-message">æš‚æ— æ¶ˆæ¯æ—¥å¿—</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="empty-message">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // ==================== æ¸…ç©ºç­›é€‰æ¡ä»¶ ====================
        
        function clearSmsFilter() {
            document.getElementById('sms-search').value = '';
            document.getElementById('sms-direction').value = '';
            document.getElementById('sms-date-start').value = '';
            document.getElementById('sms-date-end').value = '';
            loadSms();
        }
        
        function clearCallsFilter() {
            document.getElementById('call-search').value = '';
            document.getElementById('call-type').value = '';
            document.getElementById('call-date-start').value = '';
            document.getElementById('call-date-end').value = '';
            loadCalls();
        }
        
        function clearLogsFilter() {
            document.getElementById('log-msg-type').value = '';
            document.getElementById('log-date-start').value = '';
            document.getElementById('log-date-end').value = '';
            loadLogs();
        }
        
        // ==================== æ‰¹é‡æ“ä½œåŠŸèƒ½ ====================
        
        let pendingDeleteType = null;
        
        // è·å–é€‰ä¸­çš„è¡ŒID
        function getSelectedIds(type) {
            const tbody = document.getElementById(`${type}-table`);
            const rows = tbody.querySelectorAll('tr[data-id]');
            const selectedIds = [];
            rows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox && checkbox.checked) {
                    selectedIds.push(parseInt(row.dataset.id));
                }
            });
            return selectedIds;
        }
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll(type) {
            const selectAll = document.getElementById(`${type}-select-all`);
            const tbody = document.getElementById(`${type}-table`);
            const checkboxes = tbody.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                cb.closest('tr').classList.toggle('selected', selectAll.checked);
            });
            updateBatchToolbar(type);
        }
        
        // å•è¡Œé€‰æ‹©å˜åŒ–
        function onRowSelect(type) {
            const tbody = document.getElementById(`${type}-table`);
            const checkboxes = tbody.querySelectorAll('.row-checkbox');
            const selectAll = document.getElementById(`${type}-select-all`);
            
            // æ›´æ–°è¡Œé«˜äº®
            checkboxes.forEach(cb => {
                cb.closest('tr').classList.toggle('selected', cb.checked);
            });
            
            // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
            
            updateBatchToolbar(type);
        }
        
        // æ›´æ–°æ‰¹é‡æ“ä½œå·¥å…·æ 
        function updateBatchToolbar(type) {
            const selectedIds = getSelectedIds(type);
            const toolbar = document.getElementById(`${type}-batch-toolbar`);
            const countSpan = document.getElementById(`${type}-selected-count`);
            
            if (selectedIds.length > 0) {
                toolbar.classList.remove('hidden');
                countSpan.textContent = selectedIds.length;
            } else {
                toolbar.classList.add('hidden');
            }
        }
        
        // æ¸…é™¤é€‰æ‹©
        function clearSelection(type) {
            const selectAll = document.getElementById(`${type}-select-all`);
            const tbody = document.getElementById(`${type}-table`);
            
            if (selectAll) selectAll.checked = false;
            if (tbody) {
                tbody.querySelectorAll('.row-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.closest('tr').classList.remove('selected');
                });
            }
            updateBatchToolbar(type);
        }
        
        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        function exportData(type) {
            let data, filename, headers;
            
            switch (type) {
                case 'sms':
                    data = currentSmsData;
                    filename = `çŸ­ä¿¡è®°å½•_${formatDateForFilename()}.csv`;
                    headers = ['è®¾å¤‡ID', 'å¡æ§½', 'æ‰‹æœºå·', 'æ–¹å‘', 'å¯¹æ–¹å·ç ', 'å†…å®¹', 'æ—¶é—´'];
                    break;
                case 'calls':
                    data = currentCallsData;
                    filename = `é€šè¯è®°å½•_${formatDateForFilename()}.csv`;
                    headers = ['è®¾å¤‡ID', 'å¡æ§½', 'æ‰‹æœºå·', 'æ¶ˆæ¯ç±»å‹', 'é€šè¯åˆ†ç±»', 'å¯¹æ–¹å·ç ', 'æ—¶é—´', 'æ—¶é•¿(ç§’)'];
                    break;
                case 'logs':
                    data = currentLogsData;
                    filename = `æ¶ˆæ¯æ—¥å¿—_${formatDateForFilename()}.csv`;
                    headers = ['è®¾å¤‡ID', 'æ¶ˆæ¯ç±»å‹', 'ç±»å‹åç§°', 'æ—¶é—´'];
                    break;
            }
            
            if (!data || data.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            exportToCsv(data, filename, headers, type);
        }
        
        // å¯¼å‡ºé€‰ä¸­æ•°æ®
        function exportSelected(type) {
            const selectedIds = getSelectedIds(type);
            if (selectedIds.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è®°å½•');
                return;
            }
            
            let data, filename, headers;
            
            switch (type) {
                case 'sms':
                    data = currentSmsData.filter(item => selectedIds.includes(item.id));
                    filename = `çŸ­ä¿¡è®°å½•_é€‰ä¸­_${formatDateForFilename()}.csv`;
                    headers = ['è®¾å¤‡ID', 'å¡æ§½', 'æ‰‹æœºå·', 'æ–¹å‘', 'å¯¹æ–¹å·ç ', 'å†…å®¹', 'æ—¶é—´'];
                    break;
                case 'calls':
                    data = currentCallsData.filter(item => selectedIds.includes(item.id));
                    filename = `é€šè¯è®°å½•_é€‰ä¸­_${formatDateForFilename()}.csv`;
                    headers = ['è®¾å¤‡ID', 'å¡æ§½', 'æ‰‹æœºå·', 'æ¶ˆæ¯ç±»å‹', 'é€šè¯åˆ†ç±»', 'å¯¹æ–¹å·ç ', 'æ—¶é—´', 'æ—¶é•¿(ç§’)'];
                    break;
                case 'logs':
                    data = currentLogsData.filter(item => selectedIds.includes(item.id));
                    filename = `æ¶ˆæ¯æ—¥å¿—_é€‰ä¸­_${formatDateForFilename()}.csv`;
                    headers = ['è®¾å¤‡ID', 'æ¶ˆæ¯ç±»å‹', 'ç±»å‹åç§°', 'æ—¶é—´'];
                    break;
            }
            
            exportToCsv(data, filename, headers, type);
        }
        
        // ç”ŸæˆCSVå¹¶ä¸‹è½½
        function exportToCsv(data, filename, headers, type) {
            let csvContent = '\ufeff' + headers.join(',') + '\n';  // BOM for Excel
            
            data.forEach(item => {
                let row;
                switch (type) {
                    case 'sms':
                        row = [
                            item.dev_id,
                            item.slot || '',
                            item.msisdn || '',
                            item.direction === 'in' ? 'æ”¶åˆ°' : 'å‘å‡º',
                            item.phone_num,
                            `"${(item.content || '').replace(/"/g, '""')}"`,
                            formatBeijingTime(item.sms_time || item.created_at)
                        ];
                        break;
                    case 'calls':
                        row = [
                            item.dev_id,
                            item.slot || '',
                            item.msisdn || '',
                            getCallMsgTypeText(item.msg_type || 603).replace(/[\ud83c-\ud83e][\udc00-\udfff]/g, ''),  // ç§»é™¤emoji
                            item.call_type === 'incoming' ? 'æ¥ç”µ' : item.call_type === 'outgoing' ? 'å»ç”µ' : 'æœªæ¥',
                            item.phone_num,
                            formatBeijingTime(item.start_time),
                            item.duration || 0
                        ];
                        break;
                    case 'logs':
                        row = [
                            item.dev_id,
                            item.type,
                            item.type_name,
                            formatBeijingTime(item.created_at)
                        ];
                        break;
                }
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ–‡ä»¶å
        function formatDateForFilename() {
            const now = new Date();
            return `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
        }
        
        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
        function confirmDelete(type) {
            const selectedIds = getSelectedIds(type);
            if (selectedIds.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
                return;
            }
            
            pendingDeleteType = type;
            const typeNames = { sms: 'çŸ­ä¿¡', calls: 'é€šè¯', logs: 'æ—¥å¿—' };
            document.getElementById('confirm-message').textContent = 
                `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} æ¡${typeNames[type]}è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;
            document.getElementById('confirm-modal').classList.add('active');
        }
        
        // éšè—ç¡®è®¤å¼¹çª—
        function hideConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('active');
            pendingDeleteType = null;
        }
        
        // æ‰§è¡Œåˆ é™¤æ“ä½œ
        async function executeDelete() {
            if (!pendingDeleteType) return;
            
            const type = pendingDeleteType;
            const selectedIds = getSelectedIds(type);
            
            const btn = document.getElementById('confirm-delete-btn');
            btn.textContent = 'åˆ é™¤ä¸­...';
            btn.disabled = true;
            
            try {
                const apiEndpoints = { sms: 'sms', calls: 'calls', logs: 'messages' };
                const res = await apiFetch(`${API_BASE}/api/${apiEndpoints[type]}/batch-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: selectedIds })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    hideConfirmModal();
                    // é‡æ–°åŠ è½½æ•°æ®
                    switch (type) {
                        case 'sms': loadSms(); break;
                        case 'calls': loadCalls(); break;
                        case 'logs': loadLogs(); break;
                    }
                    loadStats();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            } finally {
                btn.textContent = 'ç¡®è®¤åˆ é™¤';
                btn.disabled = false;
            }
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('confirm-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('confirm-modal')) {
                hideConfirmModal();
            }
        });
        
        // ==================== è¾…åŠ©å‡½æ•° ====================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getCallTypeText(type) {
            const types = {
                'incoming': 'ğŸ“ æ¥ç”µ',
                'outgoing': 'ğŸ“± å»ç”µ',
                'missed': 'âŒ æœªæ¥'
            };
            return types[type] || type;
        }
        
        function getCallMsgTypeText(msgType) {
            const types = {
                601: 'ğŸ“³ æ¥ç”µæŒ¯é“ƒ',
                602: 'âœ… æ¥ç”µæ¥é€š',
                603: 'ğŸ“´ å¯¹æ–¹æŒ‚æ–­',
                620: 'ğŸ“² å»ç”µæ‹¨å·',
                621: 'ğŸ“³ å¯¹æ–¹æŒ¯é“ƒ',
                622: 'âœ… å»ç”µæ¥é€š',
                623: 'ğŸ“´ å»ç”µæŒ‚æ–­',
                641: 'ğŸ”¢ æœ¬åœ°æŒ‰é”®',
                642: 'ğŸ”¢ è¿œç¨‹æŒ‰é”®'
            };
            return types[msgType] || `ç±»å‹${msgType}`;
        }
        
        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '-';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins > 0 ? `${mins}åˆ†${secs}ç§’` : `${secs}ç§’`;
        }
        
        // ==================== åˆå§‹åŒ– ====================
        
        // é¡µé¢åŠ è½½æ—¶åˆ·æ–°è®¾å¤‡çŠ¶æ€
        async function refreshAllDeviceStatus() {
            console.log('[Init] åˆ·æ–°æ‰€æœ‰è®¾å¤‡çŠ¶æ€...');
            try {
                const res = await apiFetch(`${API_BASE}/api/devices/refresh-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.success) {
                    console.log(`[Init] ${data.message}`);
                }
            } catch (error) {
                console.error('[Init] åˆ·æ–°è®¾å¤‡çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // åˆå§‹åŒ–ï¼šå…ˆåˆ·æ–°è®¾å¤‡çŠ¶æ€ï¼Œå†åŠ è½½æ•°æ®
        (async function init() {
            const isLoggedIn = checkLogin();
            if (isLoggedIn) {
                await refreshAllDeviceStatus();
                loadStats();
                loadDevices();
                loadDevicesForControl();
            }
        })();
        
        // å®šæ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®
        setInterval(loadStats, 30000);
        
        // ==================== æ§åˆ¶æŒ‡ä»¤åŠŸèƒ½ ====================
        
        // å‘½ä»¤å‚æ•°å®šä¹‰
        const CMD_PARAMS = {
            'stat': { desc: 'è·å–è®¾å¤‡å½“å‰çŠ¶æ€ä¿¡æ¯', params: [] },
            'restart': { desc: 'é‡å¯å¼€å‘æ¿', params: [] },
            'now': { 
                desc: 'è®¾ç½®å¼€å‘æ¿æ—¶é—´',
                params: [
                    { name: 'p1', label: 'æ—¶é—´', placeholder: 'YYYYMMDDHHmmss (ç•™ç©ºè‡ªåŠ¨è·å–)', type: 'text' },
                    { name: 'p3', label: 'æ—¶åŒº', placeholder: '8 (åŒ—äº¬æ—¶é—´)', type: 'number', default: '8' }
                ]
            },
            'pingsec': { 
                desc: 'è®¾ç½®Pingæ¶ˆæ¯é—´éš”ç§’æ•°',
                params: [
                    { name: 'p1', label: 'é—´éš”ç§’æ•°', placeholder: 'æœ€å°10ç§’', type: 'number', required: true }
                ]
            },
            'dailyrst': { 
                desc: 'è®¾ç½®æ¯æ—¥è‡ªåŠ¨é‡å¯æ—¶é—´',
                params: [
                    { name: 'p1', label: 'é‡å¯æ—¶é—´(0-23)', placeholder: '4 (å‡Œæ™¨4ç‚¹)', type: 'number', required: true }
                ]
            },
            'slotoff': { 
                desc: 'æŒ‡å®šå¡æ§½å…³æœº',
                params: [
                    { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true }
                ]
            },
            'slotrst': { 
                desc: 'æŒ‡å®šå¡æ§½é‡å¯',
                params: [
                    { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true }
                ]
            },
            'sendsms': { 
                desc: 'é€šè¿‡æŒ‡å®šå¡æ§½å‘é€çŸ­ä¿¡',
                params: [
                    { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                    { name: 'p2', label: 'ç›®æ ‡å·ç ', placeholder: 'æ‰‹æœºå·ç ', type: 'text', required: true },
                    { name: 'p3', label: 'çŸ­ä¿¡å†…å®¹', placeholder: 'çŸ­ä¿¡å†…å®¹', type: 'textarea', required: true },
                    { name: 'tid', label: 'äº‹åŠ¡ID', placeholder: 'ç”¨äºæ¥æ”¶å‘é€ç»“æœ(å¯é€‰)', type: 'text' }
                ]
            },
            'querysms': { 
                desc: 'æŸ¥è¯¢æœ¬åœ°å­˜å‚¨çš„çŸ­ä¿¡è®°å½•',
                params: [
                    { name: 'p1', label: 'èµ·å§‹ä½ç½®', placeholder: 'ä»ç¬¬å‡ æ¡å¼€å§‹ (é»˜è®¤1)', type: 'number', default: '1' },
                    { name: 'p2', label: 'æŸ¥è¯¢æ¡æ•°', placeholder: 'æŸ¥è¯¢å¤šå°‘æ¡ (é»˜è®¤10)', type: 'number', default: '10' },
                    { name: 'p3', label: 'å…³é”®è¯', placeholder: 'ç­›é€‰å…³é”®è¯(å¯é€‰)', type: 'text' }
                ]
            },
            'teldial': { 
                desc: 'ä½¿ç”¨æŒ‡å®šå¡æ§½æ‹¨æ‰“ç”µè¯',
                params: [
                    { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                    { name: 'p2', label: 'ç›®æ ‡å·ç ', placeholder: 'æ‰‹æœºå·ç ', type: 'text', required: true },
                    { name: 'p3', label: 'é€šè¯æ—¶é•¿(ç§’)', placeholder: 'é»˜è®¤175ç§’', type: 'number' },
                    { name: 'p4', label: 'TTSè¯­éŸ³å†…å®¹', placeholder: 'æ‹¨é€šåæ’­æ”¾çš„è¯­éŸ³', type: 'textarea' },
                    { name: 'p5', label: 'TTSæ’­æ”¾æ¬¡æ•°', placeholder: 'é»˜è®¤1æ¬¡', type: 'number' },
                    { name: 'p7', label: 'æ’­å®ŒååŠ¨ä½œ', type: 'select', options: [{v:'0',t:'æ— æ“ä½œ'},{v:'1',t:'æŒ‚æ–­'}] }
                ]
            },
            'telanswer': { 
                desc: 'æ¥å¬å½“å‰æ¥ç”µ',
                params: [
                    { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true },
                    { name: 'p2', label: 'é€šè¯æ—¶é•¿(ç§’)', placeholder: 'é»˜è®¤175ç§’', type: 'number' },
                    { name: 'p3', label: 'TTSè¯­éŸ³å†…å®¹', placeholder: 'æ¥é€šåæ’­æ”¾çš„è¯­éŸ³', type: 'textarea' },
                    { name: 'p6', label: 'æ’­å®ŒååŠ¨ä½œ', type: 'select', options: [{v:'0',t:'æ— æ“ä½œ'},{v:'1',t:'æŒ‚æ–­'}] }
                ]
            },
            'telhangup': { 
                desc: 'æŒ‚æ–­å½“å‰é€šè¯',
                params: [
                    { name: 'p1', label: 'å¡æ§½å·', type: 'select', options: [{v:'1',t:'å¡æ§½1'},{v:'2',t:'å¡æ§½2'}], required: true }
                ]
            },
            'querytel': { 
                desc: 'æŸ¥è¯¢æœ¬åœ°å­˜å‚¨çš„é€šè¯è®°å½•',
                params: [
                    { name: 'p1', label: 'èµ·å§‹ä½ç½®', placeholder: 'ä»ç¬¬å‡ æ¡å¼€å§‹ (é»˜è®¤1)', type: 'number', default: '1' },
                    { name: 'p2', label: 'æŸ¥è¯¢æ¡æ•°', placeholder: 'æŸ¥è¯¢å¤šå°‘æ¡ (é»˜è®¤10)', type: 'number', default: '10' }
                ]
            },
            'addwf': { 
                desc: 'æ·»åŠ å¯è¿æ¥çš„WiFiçƒ­ç‚¹ä¿¡æ¯',
                params: [
                    { name: 'p1', label: 'WiFiåç§°', placeholder: 'WiFiçƒ­ç‚¹å(2.4G)', type: 'text', required: true },
                    { name: 'p2', label: 'WiFiå¯†ç ', placeholder: 'WiFiå¯†ç ', type: 'text', required: true }
                ]
            },
            'delwf': { 
                desc: 'åˆ é™¤å·²ä¿å­˜çš„WiFiçƒ­ç‚¹ä¿¡æ¯',
                params: [
                    { name: 'p1', label: 'WiFiåç§°', placeholder: 'è¦åˆ é™¤çš„WiFiçƒ­ç‚¹å', type: 'text', required: true }
                ]
            }
        };
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨åˆ°æ§åˆ¶é¢æ¿ä¸‹æ‹‰æ¡†
        async function loadDevicesForControl() {
            try {
                const res = await apiFetch(`${API_BASE}/api/devices`);
                const data = await res.json();
                const select = document.getElementById('ctrl-device');
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.dev_id;
                        option.dataset.ip = device.last_ip || '';
                        option.textContent = `${device.name || device.dev_id} (${device.last_ip || 'æœªçŸ¥IP'})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // è®¾å¤‡é€‰æ‹©å˜åŒ–æ—¶è‡ªåŠ¨å¡«å……IP
        function onDeviceSelect() {
            const select = document.getElementById('ctrl-device');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.dataset.ip) {
                document.getElementById('ctrl-ip').value = selectedOption.dataset.ip;
            }
        }
        
        // å‘½ä»¤é€‰æ‹©å˜åŒ–æ—¶æ˜¾ç¤ºå‚æ•°è¾“å…¥æ¡†
        function onCommandSelect() {
            const cmd = document.getElementById('ctrl-cmd').value;
            const paramsContainer = document.getElementById('cmd-params');
            
            if (!cmd || !CMD_PARAMS[cmd]) {
                paramsContainer.innerHTML = '';
                return;
            }
            
            const cmdInfo = CMD_PARAMS[cmd];
            let html = `<p style="color:#666;font-size:13px;margin-bottom:15px;">ğŸ“Œ ${cmdInfo.desc}</p>`;
            
            if (cmdInfo.params.length > 0) {
                html += '<div class="param-row">';
                cmdInfo.params.forEach(param => {
                    html += `<div class="form-group">`;
                    html += `<label for="param-${param.name}">${param.label}${param.required ? ' *' : ''}</label>`;
                    
                    if (param.type === 'select') {
                        html += `<select id="param-${param.name}" data-param="${param.name}">`;
                        html += `<option value="">-- è¯·é€‰æ‹© --</option>`;
                        param.options.forEach(opt => {
                            html += `<option value="${opt.v}">${opt.t}</option>`;
                        });
                        html += `</select>`;
                    } else if (param.type === 'textarea') {
                        html += `<textarea id="param-${param.name}" data-param="${param.name}" 
                                  placeholder="${param.placeholder || ''}">${param.default || ''}</textarea>`;
                    } else {
                        html += `<input type="${param.type || 'text'}" id="param-${param.name}" 
                                  data-param="${param.name}" placeholder="${param.placeholder || ''}"
                                  value="${param.default || ''}">`;
                    }
                    
                    html += `</div>`;
                });
                html += '</div>';
            } else {
                html += '<p style="color:#888;font-size:13px;">æ­¤å‘½ä»¤æ— éœ€é¢å¤–å‚æ•°</p>';
            }
            
            paramsContainer.innerHTML = html;
        }
        
        // å‘é€æ§åˆ¶å‘½ä»¤
        async function sendCommand() {
            const deviceIp = document.getElementById('ctrl-ip').value.trim();
            const cmd = document.getElementById('ctrl-cmd').value;
            let token = document.getElementById('ctrl-token').value.trim();
            
            // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–
            if (!token) {
                token = localStorage.getItem(TOKEN_KEY);
            }

            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰Tokenï¼Œå°è¯•ä½¿ç”¨è´¦å·å¯†ç è®¡ç®—
            if (!token) {
                const devId = document.getElementById('ctrl-device').value;
                const adminUser = document.getElementById('ctrl-admin-user').value.trim();
                const adminPass = document.getElementById('ctrl-admin-pass').value.trim();
                
                if (devId && adminUser && adminPass) {
                    const rawString = `${devId}|${adminUser}|${adminPass}`;
                    const tokenFull = await sha256(rawString);
                    token = tokenFull.substring(16, 48);
                }
            }
            
            const resultBox = document.getElementById('ctrl-result');
            
            if (!deviceIp) {
                resultBox.className = 'result-box error';
                resultBox.textContent = 'âŒ é”™è¯¯: è¯·è¾“å…¥è®¾å¤‡IPåœ°å€';
                return;
            }
            
            if (!token) {
                resultBox.className = 'result-box error';
                resultBox.textContent = 'âŒ é”™è¯¯: è¯·è¾“å…¥Tokenæˆ–ç®¡ç†å‘˜è´¦å·å¯†ç ';
                return;
            }
            
            if (!cmd) {
                resultBox.className = 'result-box error';
                resultBox.textContent = 'âŒ é”™è¯¯: è¯·é€‰æ‹©æ§åˆ¶å‘½ä»¤';
                return;
            }
            
            // æ”¶é›†å‚æ•°
            const params = {};
            document.querySelectorAll('#cmd-params [data-param]').forEach(el => {
                const paramName = el.dataset.param;
                const value = el.value.trim();
                if (value) {
                    params[paramName] = value;
                }
            });
            
            resultBox.className = 'result-box';
            resultBox.textContent = 'â³ æ­£åœ¨å‘é€å‘½ä»¤...';
            
            try {
                const response = await apiFetch(`${API_BASE}/api/control/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceIp,
                        token,
                        cmd,
                        params
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultBox.className = 'result-box success';
                    resultBox.textContent = `âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ\n\n` +
                        `ğŸ“¡ è¯·æ±‚URL:\n${data.command?.url || 'æ— '}\n\n` +
                        `ğŸ“¥ è®¾å¤‡å“åº”:\n${JSON.stringify(data.data, null, 2)}`;
                } else {
                    resultBox.className = 'result-box error';
                    resultBox.textContent = `âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ${data.error}`;
                }
            } catch (error) {
                resultBox.className = 'result-box error';
                resultBox.textContent = `âŒ è¯·æ±‚å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ${error.message}`;
            }
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResult() {
            const resultBox = document.getElementById('ctrl-result');
            resultBox.className = 'result-box';
            resultBox.textContent = 'ç­‰å¾…å‘é€å‘½ä»¤...';
        }
        
        // ==================== Token è®¡ç®—åŠŸèƒ½ ====================
        
        /**
         * SHA256 å“ˆå¸Œè®¡ç®—
         * @param {string} message - è¦å“ˆå¸Œçš„å­—ç¬¦ä¸²
         * @returns {Promise<string>} - 32ä½å¤§å†™åå…­è¿›åˆ¶å­—ç¬¦ä¸²
         */
        async function sha256(message) {
            // å°†å­—ç¬¦ä¸²ç¼–ç ä¸º UTF-8 å­—èŠ‚æ•°ç»„
            const msgBuffer = new TextEncoder().encode(message);
            // ä½¿ç”¨ Web Crypto API è®¡ç®— SHA-256
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            // è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            // è¿”å›å®Œæ•´ SHA-256 (64ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²)
            return hashHex.toUpperCase();
        }
        
        /**
         * è®¡ç®— Token
         * è§„åˆ™: SHA256(è®¾å¤‡ID|ç®¡ç†å‘˜è´¦å·|ç®¡ç†å‘˜å¯†ç )
         */
        async function calculateToken() {
            const devId = document.getElementById('calc-dev-id').value.trim();
            const adminUser = document.getElementById('calc-admin-user').value.trim();
            const adminPass = document.getElementById('calc-admin-pass').value.trim();
            const resultSpan = document.getElementById('calc-token-result');
            
            if (!devId) {
                resultSpan.style.color = '#dc2626';
                resultSpan.textContent = 'âŒ è¯·è¾“å…¥è®¾å¤‡ID';
                return null;
            }
            if (!adminUser) {
                resultSpan.style.color = '#dc2626';
                resultSpan.textContent = 'âŒ è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·';
                return null;
            }
            if (!adminPass) {
                resultSpan.style.color = '#dc2626';
                resultSpan.textContent = 'âŒ è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ';
                return null;
            }
            
            try {
                // æ‹¼æ¥å­—ç¬¦ä¸²: è®¾å¤‡ID|ç®¡ç†å‘˜è´¦å·|ç®¡ç†å‘˜å¯†ç 
                const rawString = `${devId}|${adminUser}|${adminPass}`;
                // è®¡ç®— SHA256 å¹¶å–32ä½å¤§å†™
                const tokenFull = await sha256(rawString);
                const token = tokenFull.substring(16, 48);
                
                resultSpan.style.color = '#059669';
                resultSpan.textContent = `âœ… ${token}`;
                
                return token;
            } catch (error) {
                resultSpan.style.color = '#dc2626';
                resultSpan.textContent = `âŒ è®¡ç®—å¤±è´¥: ${error.message}`;
                return null;
            }
        }
        
        /**
         * å°†è®¡ç®—çš„ Token å¡«å…¥è¾“å…¥æ¡†
         */
        async function fillTokenToInput() {
            const token = await calculateToken();
            if (token) {
                document.getElementById('ctrl-token').value = token;
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(TOKEN_KEY, token);
            }
        }
        
        // å½“é€‰æ‹©è®¾å¤‡æ—¶ï¼Œè‡ªåŠ¨å¡«å……è®¾å¤‡IDåˆ°è®¡ç®—å™¨
        const originalOnDeviceSelect = onDeviceSelect;
        onDeviceSelect = function() {
            originalOnDeviceSelect();
            const select = document.getElementById('ctrl-device');
            const devId = select.value;
            if (devId) {
                document.getElementById('calc-dev-id').value = devId;
            }
        };
    </script>
</body>
</html>
