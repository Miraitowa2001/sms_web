<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <title>IoT设备管理系统</title>
    <!-- 引入 Lucide 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ==================== 1. CSS 变量与重置 ==================== */
        :root {
            /* 品牌色 */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --secondary: #64748b;
            
            /* 状态色 */
            --success: #10b981;
            --success-bg: #d1fae5;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --danger: #ef4444;
            --danger-bg: #fee2e2;
            --info: #3b82f6;
            --info-bg: #dbeafe;

            /* 背景与文字 */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --border-color: #e2e8f0;

            /* 界面参数 */
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --header-height: 64px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            font-size: 14px;
            padding-bottom: 40px;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ==================== 2. 通用组件类 (Modular UI) ==================== */
        
        /* 按钮 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 14px;
            white-space: nowrap;
        }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: white; border-color: var(--border-color); color: var(--text-main); }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 4px 10px; font-size: 12px; height: 28px; }
        .btn-icon { padding: 6px; border-radius: 6px; }

        /* 卡片 */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248, 250, 252, 0.5);
        }
        .card-header h2 { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }

        /* 状态徽章 (Modular State Classes) */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            line-height: 1.4;
        }
        .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0.6; }
        .badge-success { background: var(--success-bg); color: #065f46; }
        .badge-success::before { background: var(--success); }
        .badge-warning { background: var(--warning-bg); color: #92400e; }
        .badge-warning::before { background: var(--warning); }
        .badge-danger { background: var(--danger-bg); color: #991b1b; }
        .badge-danger::before { background: var(--danger); }
        .badge-info { background: var(--info-bg); color: #1e40af; }
        .badge-info::before { background: var(--info); }
        .badge-neutral { background: #f1f5f9; color: #475569; }
        .badge-neutral::before { background: #94a3b8; }

        /* 表单元素 */
        .form-control {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: #fff;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .search-box { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }

        /* ==================== 3. 布局与结构 ==================== */
        
        /* 顶部导航 */
        .app-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 0 20px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-md);
        }
        .app-logo { display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 600; }
        .user-menu { display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .user-avatar { 
            width: 32px; height: 32px; background: rgba(255,255,255,0.2); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }

        .container { max-width: 1280px; margin: 20px auto; padding: 0 20px; }

        /* 统计卡片网格 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .stat-card-icon {
            position: absolute;
            right: 15px;
            top: 15px;
            color: var(--primary-light);
            opacity: 0.5;
            width: 48px; height: 48px;
        }
        .stat-label { color: var(--text-secondary); font-size: 13px; margin-bottom: 4px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
        .stat-detail { font-size: 12px; display: flex; gap: 8px; }
        
        /* 导航标签 */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .nav-item {
            padding: 10px 18px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .nav-item:hover { background: #f8fafc; color: var(--primary); }
        .nav-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        /* 页面切换逻辑 */
        .page-panel { display: none; animation: fadeIn 0.3s ease; }
        .page-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 表格样式 */
        .table-container { width: 100%; overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; table-layout: auto; }
        th { 
            background: #f8fafc; color: var(--text-secondary); 
            font-weight: 600; text-align: left; padding: 12px 16px; 
            font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        /* 登录遮罩 */
        .login-overlay {
            position: fixed; inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .login-overlay.active { opacity: 1; pointer-events: auto; }
        .login-card {
            background: white;
            width: 100%; max-width: 380px;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
        }
        .login-icon-wrap {
            width: 64px; height: 64px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 16px;
        }
        .login-card h2 { margin-bottom: 8px; font-size: 20px; }
        .login-card p { color: var(--text-secondary); margin-bottom: 24px; font-size: 14px; }

        /* Toast 提示 */
        .toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 10px;
            animation: slideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; min-width: 300px;
        }
        .toast-icon { flex-shrink: 0; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.success .toast-icon { color: var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.error .toast-icon { color: var(--danger); }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ==================== 4. 移动端适配 (Mobile Optimization) ==================== */
        @media (max-width: 768px) {
            .app-header { padding: 0 16px; height: 56px; }
            .header-title-text { display: none; } /* 仅显示 Logo 图标 */
            .container { margin: 16px auto; padding: 0 16px; }
            
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .stat-card:first-child { grid-column: 1 / -1; } /* 第一个卡片占满一行 */
            .stat-value { font-size: 24px; }
            
            .card-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .card-header > div { width: 100%; display: flex; gap: 8px; }
            .card-header .btn { flex: 1; }
            
            .search-box { flex-direction: column; }
            .search-box > * { width: 100% !important; }

            /* 移动端表格卡片化 */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { 
                background: white; 
                border: 1px solid var(--border-color); 
                border-radius: 12px; 
                margin-bottom: 16px; 
                box-shadow: var(--shadow-sm); 
                padding: 12px;
            }
            td { 
                border: none; position: relative; padding: 8px 0 8px 40%; 
                text-align: right; min-height: 36px; display: flex; align-items: center; justify-content: flex-end;
            }
            td::before { 
                position: absolute; left: 0; top: 50%; transform: translateY(-50%);
                width: 35%; white-space: nowrap; font-weight: 600; color: var(--text-secondary); text-align: left;
                content: attr(data-label); 
            }
            /* 特殊处理复选框列 */
            td:has(input[type="checkbox"]) { padding-left: 0; justify-content: flex-start; padding-bottom: 12px; border-bottom: 1px solid #f1f5f9; margin-bottom: 8px; }
            td:has(input[type="checkbox"])::before { content: none; }
            
            /* 内容溢出处理 */
            .device-id { word-break: break-all; font-family: monospace; }
            
            /* 短信内容特殊处理 */
            .sms-content {
                white-space: normal;
                max-width: 100%;
                text-align: left;
            }
            td:has(.sms-content) {
                display: block;
                padding-left: 0;
                text-align: left;
            }
            td:has(.sms-content)::before {
                position: static;
                display: block;
                margin-bottom: 4px;
                transform: none;
            }
        }
        
        /* PC端短信内容优化 */
        @media (min-width: 769px) {
            .sms-content {
                max-width: 400px;
                white-space: normal;
                word-break: break-all;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <header class="app-header">
        <div class="app-logo">
            <i data-lucide="cpu"></i>
            <span class="header-title-text">IoT 管理控制台</span>
        </div>
        <div class="user-menu" id="user-menu" style="display: none;">
            <div class="user-avatar"><i data-lucide="user" size="16"></i></div>
            <span id="current-username">管理员</span>
            <button class="btn btn-sm btn-icon" onclick="App.Auth.logout()" title="退出登录" style="background: rgba(255,255,255,0.2); border: none; color: white;">
                <i data-lucide="log-out" size="16"></i>
            </button>
        </div>
    </header>

    <div class="container">
        <!-- 统计面板 -->
        <div class="stats-grid">
            <div class="stat-card">
                <i data-lucide="server" class="stat-card-icon"></i>
                <div class="stat-label">设备总数</div>
                <div class="stat-value" id="stat-devices">-</div>
                <div class="stat-detail">
                    <span class="badge badge-success" id="stat-online-badge">0 在线</span>
                    <span class="badge badge-danger" id="stat-offline-badge">0 离线</span>
                </div>
            </div>
            <div class="stat-card">
                <i data-lucide="message-square" class="stat-card-icon"></i>
                <div class="stat-label">今日短信</div>
                <div class="stat-value" id="stat-sms-today">-</div>
                <div class="stat-detail" style="color: var(--text-secondary);">总计: <span id="stat-sms-total">0</span></div>
            </div>
            <div class="stat-card">
                <i data-lucide="phone-call" class="stat-card-icon"></i>
                <div class="stat-label">今日通话</div>
                <div class="stat-value" id="stat-calls-today">-</div>
                <div class="stat-detail" style="color: var(--text-secondary);">总计: <span id="stat-calls-total">0</span></div>
            </div>
        </div>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <div class="nav-item active" onclick="App.UI.switchTab('devices', this)">
                <i data-lucide="list"></i> 设备列表
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('sms', this)">
                <i data-lucide="message-square"></i> 短信记录
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('calls', this)">
                <i data-lucide="phone"></i> 通话记录
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('logs', this)">
                <i data-lucide="file-text"></i> 消息日志
            </div>
            <div class="nav-item" onclick="App.UI.switchTab('control', this)">
                <i data-lucide="gamepad-2"></i> 远程控制
            </div>
        </div>

        <!-- 页面 1: 设备列表 -->
        <div id="panel-devices" class="page-panel active">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="list" size="20"></i> 设备管理</h2>
                    <div>
                        <button class="btn btn-primary" onclick="App.UI.showModal('modal-add-device')">
                            <i data-lucide="plus" size="16"></i> 添加设备
                        </button>
                        <button class="btn btn-secondary" onclick="App.Modules.Devices.refresh()">
                            <i data-lucide="refresh-cw" size="16"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="table-devices">
                            <thead>
                                <tr>
                                    <th>设备ID</th>
                                    <th>名称</th>
                                    <th>状态</th>
                                    <th>网络信息</th>
                                    <th>SIM卡槽</th>
                                    <th>最后在线</th>
                                </tr>
                            </thead>
                            <tbody><!-- JS 填充 --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面 2: 短信记录 -->
        <div id="panel-sms" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="message-square" size="20"></i> 短信记录</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="App.Modules.SMS.load()">
                            <i data-lucide="refresh-cw" size="16"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <input type="text" class="form-control" id="sms-search" placeholder="搜索号码..." style="flex:1;">
                        <select class="form-control" id="sms-direction" style="width: 120px;">
                            <option value="">全部方向</option>
                            <option value="in">接收</option>
                            <option value="out">发送</option>
                        </select>
                        <button class="btn btn-primary" onclick="App.Modules.SMS.load()">搜索</button>
                    </div>
                    <div class="table-container">
                        <table id="table-sms">
                            <thead>
                                <tr>
                                    <th>设备</th>
                                    <th>卡槽</th>
                                    <th>方向</th>
                                    <th>对方号码</th>
                                    <th>内容</th>
                                    <th>时间</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面 3: 通话记录 -->
        <div id="panel-calls" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="phone" size="20"></i> 通话记录</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="App.Modules.Calls.load()">
                            <i data-lucide="refresh-cw" size="16"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <input type="text" class="form-control" id="call-search" placeholder="搜索号码..." style="flex:1;">
                        <select class="form-control" id="call-type" style="width: 120px;">
                            <option value="">全部类型</option>
                            <option value="incoming">来电</option>
                            <option value="outgoing">去电</option>
                            <option value="missed">未接</option>
                        </select>
                        <button class="btn btn-primary" onclick="App.Modules.Calls.load()">搜索</button>
                    </div>
                    <div class="table-container">
                        <table id="table-calls">
                            <thead>
                                <tr>
                                    <th>设备</th>
                                    <th>卡槽</th>
                                    <th>消息类型</th>
                                    <th>通话分类</th>
                                    <th>对方号码</th>
                                    <th>时间</th>
                                    <th>时长</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面 4: 消息日志 -->
        <div id="panel-logs" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="file-text" size="20"></i> 消息日志</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="App.Modules.Logs.load()">
                            <i data-lucide="refresh-cw" size="16"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="search-box">
                        <select class="form-control" id="log-msg-type" style="flex:1;">
                            <option value="">全部消息类型</option>
                            <optgroup label="消息大类">
                                <option value="network">联网消息 (100-102)</option>
                                <option value="sim">SIM卡消息 (202-209)</option>
                                <option value="sms">短信消息 (501-502)</option>
                                <option value="call">电话消息 (601-642)</option>
                                <option value="call_ctrl">电话控制回应 (681-689)</option>
                                <option value="command">命令应答 (401-402)</option>
                                <option value="module">通讯模组 (301)</option>
                            </optgroup>
                        </select>
                        <button class="btn btn-primary" onclick="App.Modules.Logs.load()">搜索</button>
                    </div>
                    <div class="table-container">
                        <table id="table-logs">
                            <thead>
                                <tr>
                                    <th>设备</th>
                                    <th>卡槽</th>
                                    <th>消息类型</th>
                                    <th>类型名称</th>
                                    <th>时间</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面 5: 控制终端 -->
        <div id="panel-control" class="page-panel">
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="terminal" size="20"></i> 发送指令</h2>
                </div>
                <div class="card-body">
                    <div style="max-width: 800px;">
                        <div class="search-box" style="flex-direction: column;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">目标设备</label>
                                    <select id="ctrl-device-select" class="form-control" onchange="App.Modules.Control.onDeviceSelect()"></select>
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">设备IP</label>
                                    <input type="text" id="ctrl-device-ip" class="form-control" placeholder="设备IP地址">
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%; margin-top: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">开发板账号</label>
                                    <input type="text" id="ctrl-board-user" class="form-control" value="admin" placeholder="admin">
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">开发板密码</label>
                                    <input type="password" id="ctrl-board-pass" class="form-control" value="admin" placeholder="密码">
                                </div>
                            </div>
                            
                            <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary); margin-top: 10px;">选择指令</label>
                            <select id="ctrl-cmd-select" class="form-control" onchange="App.Modules.Control.onCmdSelect()">
                                <option value="">-- 请选择 --</option>
                            </select>
                        </div>
                        
                        <div id="ctrl-params-container" style="margin: 20px 0;"></div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="App.Modules.Control.send()">
                                <i data-lucide="send" size="16"></i> 发送指令
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="font-weight: 500; font-size: 13px; color: var(--text-secondary);">执行结果</label>
                            <pre id="ctrl-result" style="background: #1e293b; color: #a5f3fc; padding: 15px; border-radius: 8px; font-family: monospace; min-height: 100px; margin-top: 5px; white-space: pre-wrap;">等待指令...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录弹窗 -->
    <div id="login-overlay" class="login-overlay active">
        <div class="login-card">
            <div class="login-icon-wrap"><i data-lucide="lock" size="32"></i></div>
            <h2>管理员登录</h2>
            <p>请输入您的凭证以访问控制台</p>
            <div style="display: flex; flex-direction: column; gap: 16px; text-align: left;">
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block;">用户名</label>
                    <input type="text" id="login-user" class="form-control" placeholder="admin">
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block;">密码</label>
                    <input type="password" id="login-pass" class="form-control" placeholder="••••••">
                </div>
                <button class="btn btn-primary" onclick="App.Auth.login()" style="justify-content: center; padding: 12px;">
                    登录系统 <i data-lucide="arrow-right" size="16"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 添加设备弹窗 -->
    <div id="modal-add-device" class="login-overlay">
        <div class="login-card" style="text-align: left; max-width: 450px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 600;">添加新设备</h3>
                <button onclick="App.UI.hideModal('modal-add-device')" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <input type="text" id="add-dev-id" class="form-control" placeholder="设备ID (必填)">
                <input type="text" id="add-dev-name" class="form-control" placeholder="设备名称">
                <input type="text" id="add-dev-ip" class="form-control" placeholder="IP地址">
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="App.UI.hideModal('modal-add-device')">取消</button>
                    <button class="btn btn-primary" onclick="App.Modules.Devices.add()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="toast-container"></div>

    <script>
        // 初始化 Lucide 图标
        lucide.createIcons();

        // ==================== App Namespace (JS Modularization) ====================
        const App = {
            config: {
                apiBase: '', // API 基础路径
                authKey: 'iot_auth_token'
            },
            
            // 命令定义
            CMD_PARAMS: {
                'stat': { desc: '获取设备当前状态信息', params: [] },
                'restart': { desc: '重启开发板', params: [] },
                'now': { 
                    desc: '设置开发板时间',
                    params: [
                        { name: 'p1', label: '时间', placeholder: 'YYYYMMDDHHmmss (留空自动获取)', type: 'text' },
                        { name: 'p3', label: '时区', placeholder: '8 (北京时间)', type: 'number', default: '8' }
                    ]
                },
                'pingsec': { 
                    desc: '设置Ping消息间隔秒数',
                    params: [
                        { name: 'p1', label: '间隔秒数', placeholder: '最小10秒', type: 'number', required: true }
                    ]
                },
                'dailyrst': { 
                    desc: '设置每日自动重启时间',
                    params: [
                        { name: 'p1', label: '重启时间(0-23)', placeholder: '4 (凌晨4点)', type: 'number', required: true }
                    ]
                },
                'chpwduser': {
                    desc: '修改用户密码',
                    params: [
                        { name: 'p1', label: '新密码', placeholder: '至少4位', type: 'text', required: true }
                    ]
                },
                'slotoff': { 
                    desc: '指定卡槽关机',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true }
                    ]
                },
                'slotrst': { 
                    desc: '指定卡槽重启',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true }
                    ]
                },
                'slotplmn': {
                    desc: '指定卡注册的运营商',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true },
                        { name: 'p2', label: '运营商代码', placeholder: '如: 46001 (0表示自动)', type: 'number', default: '0' }
                    ]
                },
                'sendsms': { 
                    desc: '通过指定卡槽发送短信',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true },
                        { name: 'p2', label: '目标号码', placeholder: '手机号码', type: 'text', required: true },
                        { name: 'p3', label: '短信内容', placeholder: '短信内容', type: 'textarea', required: true },
                        { name: 'tid', label: '事务ID', placeholder: '用于接收发送结果(可选)', type: 'text' }
                    ]
                },
                'querysms': { 
                    desc: '查询本地存储的短信记录',
                    params: [
                        { name: 'p1', label: '起始位置', placeholder: '从第几条开始 (默认1)', type: 'number', default: '1' },
                        { name: 'p2', label: '查询条数', placeholder: '查询多少条 (默认10)', type: 'number', default: '10' },
                        { name: 'p3', label: '关键词', placeholder: '筛选关键词(可选)', type: 'text' }
                    ]
                },
                'teldial': { 
                    desc: '使用指定卡槽拨打电话',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true },
                        { name: 'p2', label: '目标号码', placeholder: '手机号码', type: 'text', required: true },
                        { name: 'p3', label: '通话时长(秒)', placeholder: '默认175秒', type: 'number' },
                        { name: 'p4', label: 'TTS语音内容', placeholder: '拨通后播放的语音', type: 'textarea' },
                        { name: 'p5', label: 'TTS播放次数', placeholder: '默认1次', type: 'number' },
                        { name: 'p7', label: '播完后动作', type: 'select', options: [{v:'0',t:'无操作'},{v:'1',t:'挂断'}] }
                    ]
                },
                'telanswer': { 
                    desc: '接听当前来电',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true },
                        { name: 'p2', label: '通话时长(秒)', placeholder: '默认175秒', type: 'number' },
                        { name: 'p3', label: 'TTS语音内容', placeholder: '接通后播放的语音', type: 'textarea' },
                        { name: 'p6', label: '播完后动作', type: 'select', options: [{v:'0',t:'无操作'},{v:'1',t:'挂断'}] }
                    ]
                },
                'telhangup': { 
                    desc: '挂断当前通话',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true }
                    ]
                },
                'telstarttts': {
                    desc: '播放TTS语音',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true },
                        { name: 'p2', label: 'TTS内容', placeholder: '要播放的语音内容', type: 'textarea', required: true },
                        { name: 'p3', label: '播放次数', placeholder: '0表示无限循环', type: 'number', default: '1' },
                        { name: 'p4', label: '播放间隔(秒)', placeholder: '默认1秒', type: 'number', default: '1' },
                        { name: 'p5', label: '播完后动作', type: 'select', options: [{v:'0',t:'无操作'},{v:'1',t:'挂断'}] }
                    ]
                },
                'telstoptts': {
                    desc: '停止播放TTS语音',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true },
                        { name: 'p2', label: '停止后动作', type: 'select', options: [{v:'0',t:'无操作'},{v:'1',t:'挂断'}] }
                    ]
                },
                'telkeypress': {
                    desc: '发送DTMF按键',
                    params: [
                        { name: 'p1', label: '卡槽号', type: 'select', options: [{v:'1',t:'卡槽1'},{v:'2',t:'卡槽2'}], required: true },
                        { name: 'p2', label: '按键序列', placeholder: '如: 123#', type: 'text', required: true },
                        { name: 'p3', label: '按键时长(ms)', placeholder: '默认200ms', type: 'number', default: '200' },
                        { name: 'p4', label: '按键间隔(ms)', placeholder: '默认100ms', type: 'number', default: '100' }
                    ]
                },
                'querytel': { 
                    desc: '查询本地存储的通话记录',
                    params: [
                        { name: 'p1', label: '起始位置', placeholder: '从第几条开始 (默认1)', type: 'number', default: '1' },
                        { name: 'p2', label: '查询条数', placeholder: '查询多少条 (默认10)', type: 'number', default: '10' }
                    ]
                },
                'wf': {
                    desc: '打开或关闭WiFi',
                    params: [
                        { name: 'p1', label: '动作', type: 'select', options: [{v:'on',t:'打开'},{v:'off',t:'关闭'}], required: true }
                    ]
                },
                'addwf': { 
                    desc: '添加可连接的WiFi热点信息',
                    params: [
                        { name: 'p1', label: 'WiFi名称', placeholder: 'WiFi热点名(2.4G)', type: 'text', required: true },
                        { name: 'p2', label: 'WiFi密码', placeholder: 'WiFi密码', type: 'text', required: true }
                    ]
                },
                'delwf': { 
                    desc: '删除已保存的WiFi热点信息',
                    params: [
                        { name: 'p1', label: 'WiFi名称', placeholder: '要删除的WiFi热点名', type: 'text', required: true }
                    ]
                },
                'dailyota': {
                    desc: '设置每日自动升级时间',
                    params: [
                        { name: 'p1', label: '升级时间(0-23)', placeholder: '3 (凌晨3点)', type: 'number', required: true }
                    ]
                },
                'otanow': {
                    desc: '立即执行OTA升级',
                    params: [
                        { name: 'tid', label: '事务ID', placeholder: '用于接收结果(可选)', type: 'text' }
                    ]
                }
            },

            // --- 认证模块 ---
            Auth: {
                init() {
                    const token = localStorage.getItem(App.config.authKey);
                    if (token) {
                        document.getElementById('login-overlay').classList.remove('active');
                        document.getElementById('user-menu').style.display = 'flex';
                        App.Modules.Stats.load();
                        App.Modules.Devices.load();
                        App.Modules.Control.init();
                        
                        // 定时刷新统计
                        setInterval(() => App.Modules.Stats.load(), 30000);
                    }
                },
                async login() {
                    const user = document.getElementById('login-user').value;
                    const pass = document.getElementById('login-pass').value;
                    if (!user || !pass) return App.UI.toast('请输入用户名和密码', 'error');

                    const auth = 'Basic ' + btoa(user + ':' + pass);
                    
                    // 验证登录
                    try {
                        const res = await fetch(`${App.config.apiBase}/api/stats`, {
                            headers: { 'Authorization': auth }
                        });
                        
                        if (res.ok) {
                            localStorage.setItem(App.config.authKey, auth);
                            App.UI.toast('登录成功', 'success');
                            setTimeout(() => location.reload(), 500);
                        } else {
                            App.UI.toast('用户名或密码错误', 'error');
                        }
                    } catch (e) {
                        App.UI.toast('登录请求失败', 'error');
                    }
                },
                logout() {
                    localStorage.removeItem(App.config.authKey);
                    location.reload();
                }
            },

            // --- UI 工具 ---
            UI: {
                switchTab(panelId, tabEl) {
                    document.querySelectorAll('.page-panel').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.getElementById('panel-' + panelId).classList.add('active');
                    tabEl.classList.add('active');
                    
                    // 懒加载数据
                    if(panelId === 'sms') App.Modules.SMS.load();
                    if(panelId === 'calls') App.Modules.Calls.load();
                    if(panelId === 'logs') App.Modules.Logs.load();
                },
                showModal(id) {
                    document.getElementById(id).classList.add('active');
                },
                hideModal(id) {
                    document.getElementById(id).classList.remove('active');
                },
                toast(msg, type = 'info') {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    el.className = `toast ${type}`;
                    
                    let iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info';
                    
                    el.innerHTML = `
                        <i data-lucide="${iconName}" class="toast-icon" size="20"></i>
                        <span>${msg}</span>
                    `;
                    container.appendChild(el);
                    lucide.createIcons({ root: el });
                    
                    setTimeout(() => {
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(-20px)';
                        setTimeout(() => el.remove(), 300);
                    }, 3000);
                }
            },

            // --- 业务模块 ---
            Modules: {
                Stats: {
                    async load() {
                        try {
                            const data = await App.Utils.apiFetch('/api/stats');
                            if (data.success) {
                                document.getElementById('stat-devices').textContent = data.data.devices.total;
                                document.getElementById('stat-online-badge').textContent = `${data.data.devices.online} 在线`;
                                document.getElementById('stat-offline-badge').textContent = `${data.data.devices.offline} 离线`;
                                document.getElementById('stat-sms-today').textContent = data.data.sms.today;
                                document.getElementById('stat-sms-total').textContent = data.data.sms.total;
                                document.getElementById('stat-calls-today').textContent = data.data.calls.today;
                                document.getElementById('stat-calls-total').textContent = data.data.calls.total;
                            }
                        } catch (e) {
                            console.error('加载统计失败', e);
                        }
                    }
                },
                Devices: {
                    async load() {
                        const tbody = document.querySelector('#table-devices tbody');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">加载中...</td></tr>';
                        
                        try {
                            const data = await App.Utils.apiFetch('/api/devices');
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(d => `
                                    <tr>
                                        <td data-label="设备ID"><span class="device-id" style="font-weight:600;">${d.dev_id}</span></td>
                                        <td data-label="名称">${d.name || '-'}</td>
                                        <td data-label="状态">
                                            <span class="badge ${d.status === 'online' ? 'badge-success' : 'badge-danger'}">
                                                ${d.status === 'online' ? '在线' : '离线'}
                                            </span>
                                        </td>
                                        <td data-label="网络">${d.last_ip || '-'}</td>
                                        <td data-label="SIM卡">${App.Utils.formatSimInfo(d.sim_cards)}</td>
                                        <td data-label="最后在线" style="color:var(--text-secondary); font-size:12px;">${App.Utils.formatTime(d.last_seen_at)}</td>
                                    </tr>
                                `).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:#888;">暂无设备数据</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:red;">加载失败</td></tr>';
                        }
                    },
                    async refresh() {
                        App.UI.toast('正在刷新设备状态...', 'info');
                        try {
                            await App.Utils.apiFetch('/api/devices/refresh-all', { method: 'POST' });
                            this.load();
                            App.Modules.Stats.load();
                        } catch (e) {
                            App.UI.toast('刷新失败', 'error');
                        }
                    },
                    async add() {
                        const devId = document.getElementById('add-dev-id').value.trim();
                        const name = document.getElementById('add-dev-name').value.trim();
                        const ip = document.getElementById('add-dev-ip').value.trim();
                        
                        if (!devId) return App.UI.toast('请输入设备ID', 'warning');
                        
                        try {
                            const res = await App.Utils.apiFetch('/api/devices', {
                                method: 'POST',
                                body: JSON.stringify({ devId, name, ip })
                            });
                            if (res.success) {
                                App.UI.toast('设备添加成功', 'success');
                                App.UI.hideModal('modal-add-device');
                                this.load();
                                App.Modules.Control.loadDevices();
                            } else {
                                App.UI.toast(res.error || '添加失败', 'error');
                            }
                        } catch (e) {
                            App.UI.toast('添加失败: ' + e.message, 'error');
                        }
                    }
                },
                SMS: {
                    async load() {
                        const tbody = document.querySelector('#table-sms tbody');
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">加载中...</td></tr>';
                        
                        const phoneNum = document.getElementById('sms-search').value;
                        const direction = document.getElementById('sms-direction').value;
                        
                        let url = '/api/sms?limit=100';
                        if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                        if (direction) url += `&direction=${direction}`;
                        
                        try {
                            const data = await App.Utils.apiFetch(url);
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(sms => `
                                    <tr>
                                        <td data-label="设备">${sms.dev_id}</td>
                                        <td data-label="卡槽"><span class="badge badge-neutral">卡${sms.slot || '?'}</span></td>
                                        <td data-label="方向"><span class="badge ${sms.direction === 'in' ? 'badge-info' : 'badge-success'}">${sms.direction === 'in' ? '接收' : '发送'}</span></td>
                                        <td data-label="号码">${sms.phone_num}</td>
                                        <td data-label="内容"><div class="sms-content">${App.Utils.escapeHtml(sms.content)}</div></td>
                                        <td data-label="时间">${App.Utils.formatTime(sms.sms_time || sms.created_at)}</td>
                                    </tr>
                                `).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:#888;">暂无短信记录</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:red;">加载失败</td></tr>';
                        }
                    }
                },
                Calls: {
                    async load() {
                        const tbody = document.querySelector('#table-calls tbody');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">加载中...</td></tr>';
                        
                        const phoneNum = document.getElementById('call-search').value;
                        const callType = document.getElementById('call-type').value;
                        
                        let url = '/api/calls?limit=100';
                        if (phoneNum) url += `&phoneNum=${encodeURIComponent(phoneNum)}`;
                        if (callType) url += `&callType=${callType}`;
                        
                        try {
                            const data = await App.Utils.apiFetch(url);
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(call => `
                                    <tr>
                                        <td data-label="设备">${call.dev_id}</td>
                                        <td data-label="卡槽"><span class="badge badge-neutral">卡${call.slot || '?'}</span></td>
                                        <td data-label="消息类型">${App.Utils.getCallMsgTypeText(call.msg_type)}</td>
                                        <td data-label="通话分类">${App.Utils.getCallTypeText(call.call_type)}</td>
                                        <td data-label="对方号码">${call.phone_num}</td>
                                        <td data-label="时间">${App.Utils.formatTime(call.start_time)}</td>
                                        <td data-label="时长">${App.Utils.formatDuration(call.duration)}</td>
                                    </tr>
                                `).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color:#888;">暂无通话记录</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color:red;">加载失败</td></tr>';
                        }
                    }
                },
                Logs: {
                    async load() {
                        const tbody = document.querySelector('#table-logs tbody');
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">加载中...</td></tr>';
                        
                        const msgType = document.getElementById('log-msg-type').value;
                        let url = '/api/messages?limit=100';
                        if (msgType) {
                            if (isNaN(msgType)) url += `&msgCategory=${msgType}`;
                            else url += `&msgType=${msgType}`;
                        }
                        
                        try {
                            const data = await App.Utils.apiFetch(url);
                            if (data.success && data.data.length > 0) {
                                tbody.innerHTML = data.data.map(log => {
                                    let slot = '-';
                                    try {
                                        if (log.raw_data) {
                                            const raw = JSON.parse(log.raw_data);
                                            if (raw.slot) slot = '卡' + raw.slot;
                                            else if (raw.slotInfo) slot = '多卡信息';
                                        }
                                    } catch(e) {}
                                    
                                    return `
                                    <tr>
                                        <td data-label="设备">${log.dev_id}</td>
                                        <td data-label="卡槽"><span class="badge badge-neutral">${slot}</span></td>
                                        <td data-label="消息类型">${log.type}</td>
                                        <td data-label="类型名称">${log.type_name}</td>
                                        <td data-label="时间">${App.Utils.formatTime(log.created_at)}</td>
                                    </tr>
                                `}).join('');
                            } else {
                                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color:#888;">暂无消息日志</td></tr>';
                            }
                        } catch (e) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color:red;">加载失败</td></tr>';
                        }
                    }
                },
                Control: {
                    init() {
                        this.loadDevices();
                        this.renderCmdOptions();
                    },
                    async loadDevices() {
                        try {
                            const data = await App.Utils.apiFetch('/api/devices');
                            const select = document.getElementById('ctrl-device-select');
                            select.innerHTML = '';
                            
                            if (data.success && data.data.length > 0) {
                                data.data.forEach(device => {
                                    const option = document.createElement('option');
                                    option.value = device.dev_id;
                                    option.dataset.ip = device.last_ip || '';
                                    option.textContent = `${device.name || device.dev_id} (${device.last_ip || '未知IP'})`;
                                    select.appendChild(option);
                                });
                                this.onDeviceSelect();
                            }
                        } catch (e) {
                            console.error('加载设备列表失败', e);
                        }
                    },
                    renderCmdOptions() {
                        const select = document.getElementById('ctrl-cmd-select');
                        select.innerHTML = '<option value="">-- 请选择 --</option>';
                        for (const [key, val] of Object.entries(App.CMD_PARAMS)) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = `${val.desc} (${key})`;
                            select.appendChild(option);
                        }
                    },
                    onDeviceSelect() {
                        const select = document.getElementById('ctrl-device-select');
                        const selectedOption = select.options[select.selectedIndex];
                        if (selectedOption) {
                            document.getElementById('ctrl-device-ip').value = selectedOption.dataset.ip || '';
                        }
                    },
                    onCmdSelect() {
                        const cmd = document.getElementById('ctrl-cmd-select').value;
                        const container = document.getElementById('ctrl-params-container');
                        container.innerHTML = '';
                        
                        if (!cmd || !App.CMD_PARAMS[cmd]) return;
                        
                        const cmdInfo = App.CMD_PARAMS[cmd];
                        
                        if (cmdInfo.params.length > 0) {
                            let html = '<div class="form-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">';
                            cmdInfo.params.forEach(param => {
                                html += `<div class="form-group" style="display:flex; flex-direction:column; gap:5px;">`;
                                html += `<label style="font-size:13px; color:var(--text-secondary);">${param.label}${param.required ? ' *' : ''}</label>`;
                                
                                if (param.type === 'select') {
                                    html += `<select class="form-control" data-param="${param.name}">`;
                                    param.options.forEach(opt => {
                                        html += `<option value="${opt.v}">${opt.t}</option>`;
                                    });
                                    html += `</select>`;
                                } else if (param.type === 'textarea') {
                                    html += `<textarea class="form-control" data-param="${param.name}" placeholder="${param.placeholder || ''}" rows="3">${param.default || ''}</textarea>`;
                                } else {
                                    html += `<input type="${param.type || 'text'}" class="form-control" data-param="${param.name}" placeholder="${param.placeholder || ''}" value="${param.default || ''}">`;
                                }
                                html += `</div>`;
                            });
                            html += '</div>';
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = `<div style="color:var(--text-secondary); font-size:13px;">此指令无额外参数</div>`;
                        }
                    },
                    async send() {
                        const deviceIp = document.getElementById('ctrl-device-ip').value.trim();
                        const cmd = document.getElementById('ctrl-cmd-select').value;
                        const devId = document.getElementById('ctrl-device-select').value;
                        const user = document.getElementById('ctrl-board-user').value.trim();
                        const pass = document.getElementById('ctrl-board-pass').value.trim();
                        
                        if (!deviceIp) return App.UI.toast('请输入设备IP', 'error');
                        if (!cmd) return App.UI.toast('请选择指令', 'warning');
                        if (!user || !pass) return App.UI.toast('请输入开发板账号和密码', 'warning');
                        
                        // 自动计算 Token
                        const raw = `${devId}|${user}|${pass}`;
                        const msgBuffer = new TextEncoder().encode(raw);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
                        const token = hashHex.substring(16, 48);
                        
                        const params = {};
                        document.querySelectorAll('#ctrl-params-container [data-param]').forEach(el => {
                            const val = el.value.trim();
                            if (val) params[el.dataset.param] = val;
                        });
                        
                        const resultBox = document.getElementById('ctrl-result');
                        resultBox.className = 'result-box';
                        resultBox.textContent = `[${new Date().toLocaleTimeString()}] 正在发送 ${cmd} 指令...`;
                        
                        try {
                            const res = await App.Utils.apiFetch('/api/control/send', {
                                method: 'POST',
                                body: JSON.stringify({ deviceIp, token, cmd, params })
                            });
                            
                            if (res.success) {
                                resultBox.className = 'result-box success'; // Note: style needs to be defined or inline
                                resultBox.style.color = '#a7f3d0';
                                resultBox.textContent = `✅ 命令执行成功\n\n` +
                                    `📡 请求URL:\n${res.command?.url || '无'}\n\n` +
                                    `📥 设备响应:\n${JSON.stringify(res.data, null, 2)}`;
                                App.UI.toast('指令发送成功', 'success');
                            } else {
                                throw new Error(res.error || '未知错误');
                            }
                        } catch (e) {
                            resultBox.className = 'result-box error'; // Note: style needs to be defined or inline
                            resultBox.style.color = '#fecaca';
                            resultBox.textContent = `❌ 执行失败: ${e.message}`;
                            App.UI.toast('指令发送失败', 'error');
                        }
                    }
                }
            },
            
            // --- 辅助函数 ---
            Utils: {
                async apiFetch(url, options = {}) {
                    const token = localStorage.getItem(App.config.authKey);
                    const headers = {
                        'Content-Type': 'application/json',
                        ...options.headers
                    };
                    if (token) headers['Authorization'] = token;
                    
                    const res = await fetch(App.config.apiBase + url, { ...options, headers });
                    if (res.status === 401) {
                        App.Auth.logout();
                        throw new Error('未授权');
                    }
                    return res.json();
                },
                formatTime(timeStr) {
                    if (!timeStr) return '-';
                    // 如果是时间戳（纯数字）
                    if (/^\d+$/.test(timeStr)) {
                        try {
                            // 假设是UTC时间戳，+8小时转北京时间
                            const ts = parseInt(timeStr) * 1000;
                            const date = new Date(ts + 8 * 3600 * 1000);
                            const pad = n => n < 10 ? '0' + n : n;
                            return `${date.getUTCFullYear()}-${pad(date.getUTCMonth() + 1)}-${pad(date.getUTCDate())} ${pad(date.getUTCHours())}:${pad(date.getUTCMinutes())}:${pad(date.getUTCSeconds())}`;
                        } catch (e) { return timeStr; }
                    }
                    // 如果是ISO字符串，尝试转换
                    try {
                        const date = new Date(timeStr);
                        // 简单处理，直接显示本地时间（假设浏览器在中国）
                        // 或者手动处理时区
                        return date.toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-');
                    } catch (e) { return timeStr; }
                },
                formatSimInfo(simCards) {
                    if (!simCards || simCards.length === 0) return '-';
                    return simCards.map(sim => {
                        const statusClass = sim.status === 'ready' ? 'badge-success' : 'badge-danger';
                        return `<span class="badge ${statusClass}" style="margin-right:5px;">卡${sim.slot}: ${sim.msisdn || '未知'}</span>`;
                    }).join('');
                },
                escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                getCallTypeText(type) {
                    const map = { 'incoming': '📞 来电', 'outgoing': '📱 去电', 'missed': '❌ 未接' };
                    return map[type] || type;
                },
                getCallMsgTypeText(type) {
                    const map = {
                        601: '📳 来电振铃', 602: '✅ 来电接通', 603: '📴 对方挂断',
                        620: '📲 去电拨号', 621: '📳 对方振铃', 622: '✅ 去电接通', 623: '📴 去电挂断'
                    };
                    return map[type] || type;
                },
                formatDuration(seconds) {
                    if (!seconds) return '-';
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return m > 0 ? `${m}分${s}秒` : `${s}秒`;
                }
            }
        };

        // 启动应用
        document.addEventListener('DOMContentLoaded', App.Auth.init);

    </script>
</body>
</html>